---
title: Общие сведения о ведении журналов и перехвате — EF Core
description: Общие сведения о ведении журналов, событиях, перехватчиках и диагностике для EF Core
author: ajcvickers
ms.date: 10/01/2020
uid: core/logging-events-diagnostics/index
ms.openlocfilehash: 5ddbffc8d39e97065f2e06af14443c62b4a9465d
ms.sourcegitcommit: 032a1767d7a6e42052a005f660b80372c6521e7e
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/12/2021
ms.locfileid: "98129230"
---
# <a name="overview-of-logging-and-interception"></a><span data-ttu-id="e1d0b-103">Общие сведения о ведении журналов и перехвате</span><span class="sxs-lookup"><span data-stu-id="e1d0b-103">Overview of Logging and Interception</span></span>

<span data-ttu-id="e1d0b-104">Entity Framework Core (EF Core) содержит несколько механизмов создания журналов, реагирования на события и получения диагностики.</span><span class="sxs-lookup"><span data-stu-id="e1d0b-104">Entity Framework Core (EF Core) contains several mechanisms for generating logs, responding to events, and obtaining diagnostics.</span></span> <span data-ttu-id="e1d0b-105">Каждый из них предназначен для различных ситуаций, и важно выбрать оптимальный механизм для конкретной задачи, даже если для ее решения подходят несколько механизмов.</span><span class="sxs-lookup"><span data-stu-id="e1d0b-105">Each of these is tailored to different situations, and it is important to select the best mechanism for the task in hand, even when multiple mechanisms could work.</span></span> <span data-ttu-id="e1d0b-106">Например, для ведения журнала SQL можно использовать перехватчик базы данных, однако лучше для этой цели подойдет один из механизмов, адаптированный для ведения журнала.</span><span class="sxs-lookup"><span data-stu-id="e1d0b-106">For example, a database interceptor could be used to log SQL, but this is better handled by one of the mechanisms tailored to logging.</span></span> <span data-ttu-id="e1d0b-107">На этой странице представлен обзор каждого из этих механизмов и описано, когда они должны использоваться.</span><span class="sxs-lookup"><span data-stu-id="e1d0b-107">This page presents an overview of each of these mechanisms and describes when each should be used.</span></span>

## <a name="quick-reference"></a><span data-ttu-id="e1d0b-108">Краткий справочник</span><span class="sxs-lookup"><span data-stu-id="e1d0b-108">Quick reference</span></span>

<span data-ttu-id="e1d0b-109">В указанной ниже таблице приведены краткие сведения о различиях между описанными здесь механизмами.</span><span class="sxs-lookup"><span data-stu-id="e1d0b-109">The table below provides a quick reference for the differences between the mechanisms described here.</span></span>

| <span data-ttu-id="e1d0b-110">Механизм</span><span class="sxs-lookup"><span data-stu-id="e1d0b-110">Mechanism</span></span> |  <span data-ttu-id="e1d0b-111">Async</span><span class="sxs-lookup"><span data-stu-id="e1d0b-111">Async</span></span> | <span data-ttu-id="e1d0b-112">Область</span><span class="sxs-lookup"><span data-stu-id="e1d0b-112">Scope</span></span> | <span data-ttu-id="e1d0b-113">Зарегистрировано</span><span class="sxs-lookup"><span data-stu-id="e1d0b-113">Registered</span></span> | <span data-ttu-id="e1d0b-114">предполагаемое использование;</span><span class="sxs-lookup"><span data-stu-id="e1d0b-114">Intended use</span></span>
|:----------|--------|-------|------------|-------------
| <span data-ttu-id="e1d0b-115">Простое ведение журнала</span><span class="sxs-lookup"><span data-stu-id="e1d0b-115">Simple Logging</span></span> | <span data-ttu-id="e1d0b-116">нет</span><span class="sxs-lookup"><span data-stu-id="e1d0b-116">No</span></span> | <span data-ttu-id="e1d0b-117">Для каждого контекста</span><span class="sxs-lookup"><span data-stu-id="e1d0b-117">Per context</span></span> | <span data-ttu-id="e1d0b-118">Конфигурация контекста</span><span class="sxs-lookup"><span data-stu-id="e1d0b-118">Context configuration</span></span> | <span data-ttu-id="e1d0b-119">Ведение журнала во время разработки</span><span class="sxs-lookup"><span data-stu-id="e1d0b-119">Development-time logging</span></span>
| <span data-ttu-id="e1d0b-120">Microsoft.Extensions.Logging</span><span class="sxs-lookup"><span data-stu-id="e1d0b-120">Microsoft.Extensions.Logging</span></span> | <span data-ttu-id="e1d0b-121">нет</span><span class="sxs-lookup"><span data-stu-id="e1d0b-121">No</span></span> | <span data-ttu-id="e1d0b-122">Для каждого контекста\*</span><span class="sxs-lookup"><span data-stu-id="e1d0b-122">Per context\*</span></span> | <span data-ttu-id="e1d0b-123">Внедрение зависимостей</span><span class="sxs-lookup"><span data-stu-id="e1d0b-123">D.I.</span></span> <span data-ttu-id="e1d0b-124">или конфигурация контекста</span><span class="sxs-lookup"><span data-stu-id="e1d0b-124">or context configuration</span></span> | <span data-ttu-id="e1d0b-125">Ведение журнала в рабочей среде</span><span class="sxs-lookup"><span data-stu-id="e1d0b-125">Production logging</span></span>
| <span data-ttu-id="e1d0b-126">События</span><span class="sxs-lookup"><span data-stu-id="e1d0b-126">Events</span></span> | <span data-ttu-id="e1d0b-127">нет</span><span class="sxs-lookup"><span data-stu-id="e1d0b-127">No</span></span> | <span data-ttu-id="e1d0b-128">Для каждого контекста</span><span class="sxs-lookup"><span data-stu-id="e1d0b-128">Per context</span></span> | <span data-ttu-id="e1d0b-129">Любое время</span><span class="sxs-lookup"><span data-stu-id="e1d0b-129">Any time</span></span> | <span data-ttu-id="e1d0b-130">Реагирование на события EF</span><span class="sxs-lookup"><span data-stu-id="e1d0b-130">Reacting to EF events</span></span>
| <span data-ttu-id="e1d0b-131">Перехватчики</span><span class="sxs-lookup"><span data-stu-id="e1d0b-131">Interceptors</span></span> | <span data-ttu-id="e1d0b-132">Да</span><span class="sxs-lookup"><span data-stu-id="e1d0b-132">Yes</span></span> | <span data-ttu-id="e1d0b-133">Для каждого контекста</span><span class="sxs-lookup"><span data-stu-id="e1d0b-133">Per context</span></span> | <span data-ttu-id="e1d0b-134">Конфигурация контекста</span><span class="sxs-lookup"><span data-stu-id="e1d0b-134">Context configuration</span></span> | <span data-ttu-id="e1d0b-135">Обработка операций EF</span><span class="sxs-lookup"><span data-stu-id="e1d0b-135">Manipulating EF operations</span></span>
| <span data-ttu-id="e1d0b-136">Прослушиватели данных диагностики</span><span class="sxs-lookup"><span data-stu-id="e1d0b-136">Diagnostics listeners</span></span> | <span data-ttu-id="e1d0b-137">нет</span><span class="sxs-lookup"><span data-stu-id="e1d0b-137">No</span></span> | <span data-ttu-id="e1d0b-138">Процесс</span><span class="sxs-lookup"><span data-stu-id="e1d0b-138">Process</span></span> | <span data-ttu-id="e1d0b-139">Глобально</span><span class="sxs-lookup"><span data-stu-id="e1d0b-139">Globally</span></span> | <span data-ttu-id="e1d0b-140">Диагностика приложения</span><span class="sxs-lookup"><span data-stu-id="e1d0b-140">Application diagnostics</span></span>

<span data-ttu-id="e1d0b-141">\*Обычно `Microsoft.Extensions.Logging` настраивается для каждого приложения посредством внедрения зависимостей. Однако на уровне EF каждый контекст при необходимости _можно_ настроить с помощью разных средств ведения журнала.</span><span class="sxs-lookup"><span data-stu-id="e1d0b-141">\*Typically `Microsoft.Extensions.Logging` is configured per-application via dependency injection However, at the EF level, each context _can_ be configured with a different logger if needed.</span></span>

## <a name="simple-logging"></a><span data-ttu-id="e1d0b-142">Простое ведение журнала</span><span class="sxs-lookup"><span data-stu-id="e1d0b-142">Simple logging</span></span>

> [!NOTE]
> <span data-ttu-id="e1d0b-143">Эта возможность появилась в EF Core 5.0.</span><span class="sxs-lookup"><span data-stu-id="e1d0b-143">This feature was introduced in EF Core 5.0.</span></span>

<span data-ttu-id="e1d0b-144">Доступ к журналам EF Core можно получить из любого типа приложений с помощью метода <xref:Microsoft.EntityFrameworkCore.DbContextOptionsBuilder.LogTo%2A> при [настройке экземпляра DbContext](xref:core/dbcontext-configuration/index).</span><span class="sxs-lookup"><span data-stu-id="e1d0b-144">EF Core logs can be accessed from any type of application through the use of <xref:Microsoft.EntityFrameworkCore.DbContextOptionsBuilder.LogTo%2A> when [configuring a DbContext instance](xref:core/dbcontext-configuration/index).</span></span> <span data-ttu-id="e1d0b-145">Такая конфигурация обычно выполняется при переопределении <xref:Microsoft.EntityFrameworkCore.DbContext.OnConfiguring%2A?displayProperty=nameWithType>.</span><span class="sxs-lookup"><span data-stu-id="e1d0b-145">This configuration is commonly done in an override of <xref:Microsoft.EntityFrameworkCore.DbContext.OnConfiguring%2A?displayProperty=nameWithType>.</span></span> <span data-ttu-id="e1d0b-146">Пример:</span><span class="sxs-lookup"><span data-stu-id="e1d0b-146">For example:</span></span>

<!--
    protected override void OnConfiguring(DbContextOptionsBuilder optionsBuilder)
        => optionsBuilder.LogTo(Console.WriteLine);
-->
[!code-csharp[LogToConsole](../../../samples/core/Miscellaneous/Logging/SimpleLogging/Program.cs?name=LogToConsole)]

<span data-ttu-id="e1d0b-147">Эта концепция аналогична <xref:System.Data.Entity.Database.Log?displayProperty=nameWithType> в EF6.</span><span class="sxs-lookup"><span data-stu-id="e1d0b-147">This concept is similar to <xref:System.Data.Entity.Database.Log?displayProperty=nameWithType> in EF6.</span></span>

<span data-ttu-id="e1d0b-148">Дополнительные сведения см. в статье [Простое ведение журнала](xref:core/logging-events-diagnostics/simple-logging).</span><span class="sxs-lookup"><span data-stu-id="e1d0b-148">See [Simple Logging](xref:core/logging-events-diagnostics/simple-logging) for more information.</span></span>

## <a name="microsoftextensionslogging"></a><span data-ttu-id="e1d0b-149">Microsoft.Extensions.Logging</span><span class="sxs-lookup"><span data-stu-id="e1d0b-149">Microsoft.Extensions.Logging</span></span>

<span data-ttu-id="e1d0b-150">[Microsoft.Extensions.Logging](/dotnet/core/extensions/logging) — это расширяемый механизм ведения журнала с поставщиками подключаемых модулей для многих распространенных систем ведения журналов.</span><span class="sxs-lookup"><span data-stu-id="e1d0b-150">[Microsoft.Extensions.Logging](/dotnet/core/extensions/logging) is an extensible logging mechanism with plug-in providers for many common logging systems.</span></span> <span data-ttu-id="e1d0b-151">EF Core полностью интегрируется с `Microsoft.Extensions.Logging`. Эта форма ведения журнала используется по умолчанию для приложений ASP.NET Core.</span><span class="sxs-lookup"><span data-stu-id="e1d0b-151">EF Core fully integrates with `Microsoft.Extensions.Logging` and this form of logging is used by default for ASP.NET Core applications.</span></span>

<span data-ttu-id="e1d0b-152">Дополнительные сведения см. в статье об [использовании Microsoft.Extensions.Logging в EF Core](xref:core/logging-events-diagnostics/extensions-logging).</span><span class="sxs-lookup"><span data-stu-id="e1d0b-152">See [Using Microsoft.Extensions.Logging in EF Core](xref:core/logging-events-diagnostics/extensions-logging) for more information.</span></span>

## <a name="events"></a><span data-ttu-id="e1d0b-153">События</span><span class="sxs-lookup"><span data-stu-id="e1d0b-153">Events</span></span>

> [!NOTE]
> <span data-ttu-id="e1d0b-154">В EF Core 5.0 были добавлены дополнительные события.</span><span class="sxs-lookup"><span data-stu-id="e1d0b-154">Additional events were introduced in EF Core 5.0.</span></span>

<span data-ttu-id="e1d0b-155">EF Core предоставляет [события .NET](/dotnet/standard/events/) в качестве обратных вызовов, когда в коде EF Core происходят определенные действия.</span><span class="sxs-lookup"><span data-stu-id="e1d0b-155">EF Core exposes [.NET events](/dotnet/standard/events/) to act as callbacks when certain things happen in the EF Core code.</span></span> <span data-ttu-id="e1d0b-156">Использовать события проще по сравнению с перехватчиками. Они также обеспечивают более гибкую регистрацию.</span><span class="sxs-lookup"><span data-stu-id="e1d0b-156">Events are simpler than interceptors and allow more flexible registration.</span></span> <span data-ttu-id="e1d0b-157">Однако они только синхронизируются и поэтому не могут выполнять неблокирующие асинхронные операции ввода-вывода.</span><span class="sxs-lookup"><span data-stu-id="e1d0b-157">However, they are sync only and so cannot perform non-blocking async I/O.</span></span>

<span data-ttu-id="e1d0b-158">События регистрируются для каждого экземпляра DbContext. Эту регистрацию можно выполнить в любое время.</span><span class="sxs-lookup"><span data-stu-id="e1d0b-158">Events are registered per DbContext instance and this registration can be done at any time.</span></span> <span data-ttu-id="e1d0b-159">С помощью [прослушивателя диагностики](xref:core/logging-events-diagnostics/diagnostic-listeners) можно получить ту же информацию, но для всех экземпляров DbContext в процессе.</span><span class="sxs-lookup"><span data-stu-id="e1d0b-159">Use a [diagnostic listener](xref:core/logging-events-diagnostics/diagnostic-listeners) to get the same information but for all DbContext instances in the process.</span></span>

<span data-ttu-id="e1d0b-160">Дополнительные сведения см. в статье о [событиях .NET в EF Core](xref:core/logging-events-diagnostics/events).</span><span class="sxs-lookup"><span data-stu-id="e1d0b-160">See [.NET Events in EF Core](xref:core/logging-events-diagnostics/events) for more information.</span></span>

## <a name="interception"></a><span data-ttu-id="e1d0b-161">Interception</span><span class="sxs-lookup"><span data-stu-id="e1d0b-161">Interception</span></span>

> [!NOTE]
> <span data-ttu-id="e1d0b-162">Эта возможность появилась в EF Core 3.0.</span><span class="sxs-lookup"><span data-stu-id="e1d0b-162">This feature was introduced in EF Core 3.0.</span></span> <span data-ttu-id="e1d0b-163">В EF Core 5.0 были добавлены дополнительные перехватчики.</span><span class="sxs-lookup"><span data-stu-id="e1d0b-163">Additional interceptors were introduced in EF Core 5.0.</span></span>

<span data-ttu-id="e1d0b-164">Перехватчики EF Core позволяют выполнять перехват, изменение и подавление операций EF Core.</span><span class="sxs-lookup"><span data-stu-id="e1d0b-164">EF Core interceptors enable interception, modification, and/or suppression of EF Core operations.</span></span> <span data-ttu-id="e1d0b-165">Сюда входят низкоуровневые операции с базами данных, такие как выполнение команды, а также операции более высокого уровня, такие как вызовы SaveChanges.</span><span class="sxs-lookup"><span data-stu-id="e1d0b-165">This includes low-level database operations such as executing a command, as well as higher-level operations, such as calls to SaveChanges.</span></span>

<span data-ttu-id="e1d0b-166">Перехватчики отличаются от ведения журнала и диагностики, так как они позволяют изменять или подавлять перехватываемую операцию.</span><span class="sxs-lookup"><span data-stu-id="e1d0b-166">Interceptors are different from logging and diagnostics in that they allow modification or suppression of the operation being intercepted.</span></span> <span data-ttu-id="e1d0b-167">Для ведения журнала лучше всего использовать [средство простого ведения журнала](xref:core/logging-events-diagnostics/simple-logging) или [Microsoft.Extensions.Logging](xref:core/logging-events-diagnostics/extensions-logging).</span><span class="sxs-lookup"><span data-stu-id="e1d0b-167">[Simple logging](xref:core/logging-events-diagnostics/simple-logging) or [Microsoft.Extensions.Logging](xref:core/logging-events-diagnostics/extensions-logging) are better choices for logging.</span></span>

<span data-ttu-id="e1d0b-168">Перехватчики регистрируются для каждого экземпляра DbContext во время настройки контекста.</span><span class="sxs-lookup"><span data-stu-id="e1d0b-168">Interceptors are registered per DbContext instance when the context is configured.</span></span> <span data-ttu-id="e1d0b-169">С помощью [прослушивателя диагностики](xref:core/logging-events-diagnostics/diagnostic-listeners) можно получить ту же информацию, но для всех экземпляров DbContext в процессе.</span><span class="sxs-lookup"><span data-stu-id="e1d0b-169">Use a [diagnostic listener](xref:core/logging-events-diagnostics/diagnostic-listeners) to get the same information but for all DbContext instances in the process.</span></span>

<span data-ttu-id="e1d0b-170">Подробные сведения см. в статье [Перехватчики](xref:core/logging-events-diagnostics/interceptors).</span><span class="sxs-lookup"><span data-stu-id="e1d0b-170">See [Interception](xref:core/logging-events-diagnostics/interceptors) for more information.</span></span>

## <a name="diagnostic-listeners"></a><span data-ttu-id="e1d0b-171">Прослушиватели диагностики</span><span class="sxs-lookup"><span data-stu-id="e1d0b-171">Diagnostic listeners</span></span>

<span data-ttu-id="e1d0b-172">Прослушиватели диагностики позволяют прослушивать любое событие EF Core, возникающее в текущем процессе .NET.</span><span class="sxs-lookup"><span data-stu-id="e1d0b-172">Diagnostic listeners allow listening for any EF Core event that occurs in the current .NET process.</span></span>

<span data-ttu-id="e1d0b-173">Прослушиватели диагностики не подходят для получения событий из одного экземпляра DbContext.</span><span class="sxs-lookup"><span data-stu-id="e1d0b-173">Diagnostic listeners are not suitable for getting events from a single DbContext instance.</span></span> <span data-ttu-id="e1d0b-174">Перехватчики EF Core предоставляют доступ к одним и тем же событиям с регистрацией для каждого контекста.</span><span class="sxs-lookup"><span data-stu-id="e1d0b-174">EF Core interceptors provide access to the same events with per-context registration.</span></span>

<span data-ttu-id="e1d0b-175">Прослушиватели диагностики не предназначены для ведения журнала.</span><span class="sxs-lookup"><span data-stu-id="e1d0b-175">Diagnostic listeners are not designed for logging.</span></span> <span data-ttu-id="e1d0b-176">Для ведения журнала лучше всего использовать [средство простого ведения журнала](xref:core/logging-events-diagnostics/simple-logging) или [Microsoft.Extensions.Logging](xref:core/logging-events-diagnostics/extensions-logging).</span><span class="sxs-lookup"><span data-stu-id="e1d0b-176">[Simple logging](xref:core/logging-events-diagnostics/simple-logging) or [Microsoft.Extensions.Logging](xref:core/logging-events-diagnostics/extensions-logging) are better choices for logging.</span></span>

<span data-ttu-id="e1d0b-177">Дополнительные сведения см. в статье [об использовании прослушивателей диагностики в EF Core](xref:core/logging-events-diagnostics/diagnostic-listeners).</span><span class="sxs-lookup"><span data-stu-id="e1d0b-177">See [Using diagnostic listeners in EF Core](xref:core/logging-events-diagnostics/diagnostic-listeners) for more information.</span></span>
