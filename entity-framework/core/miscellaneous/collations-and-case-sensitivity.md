---
title: Параметры сортировки и чувствительность к регистру — EF Core
description: Настройка параметров сортировки и учета регистра в базе данных и запросах
author: roji
ms.date: 04/27/2020
ms.assetid: bde4e0ee-fba3-4813-a849-27049323d301
uid: core/miscellaneous/collations-and-case-sensitivity
ms.openlocfilehash: b3874847922cb39aa57d50813e6e50ff7db72eb9
ms.sourcegitcommit: ebfd3382fc583bc90f0da58e63d6e3382b30aa22
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 06/25/2020
ms.locfileid: "85370569"
---
# <a name="collations-and-case-sensitivity"></a><span data-ttu-id="7d9e5-103">Параметры сортировки и чувствительность к регистру</span><span class="sxs-lookup"><span data-stu-id="7d9e5-103">Collations and Case Sensitivity</span></span>

> [!NOTE]
> <span data-ttu-id="7d9e5-104">Эта возможность появилась в EF Core 5.0.</span><span class="sxs-lookup"><span data-stu-id="7d9e5-104">This feature is introduced in EF Core 5.0.</span></span>

<span data-ttu-id="7d9e5-105">Обработка текста в базах данных может быть сложной и требует более тщательного внимания пользователя.</span><span class="sxs-lookup"><span data-stu-id="7d9e5-105">Text processing in databases can be a complex, and requires more user attention that one would suspect.</span></span> <span data-ttu-id="7d9e5-106">В одном случае базы данных значительно зависят от того, как они обрабатывали текст; Например, хотя в некоторых базах данных учитывается регистр по умолчанию (например, SQLite, PostgreSQL), другие не учитывают регистр (SQL Server, MySQL).</span><span class="sxs-lookup"><span data-stu-id="7d9e5-106">For one thing, databases vary considerably in how they handle text; for example, while some databases are case-sensitive by default (e.g. Sqlite, PostgreSQL), others are case-insensitive (SQL Server, MySQL).</span></span> <span data-ttu-id="7d9e5-107">Кроме того, в связи с использованием индексов, чувствительность к регистру и аналогичные аспекты могут иметь более далекое влияние на производительность запросов: в то время как в этом случае может возникнуть желание использовать `string.Lower` для принудительного сравнения без учета регистра в базе данных с учетом регистра, это может помешать приложению использовать индексы.</span><span class="sxs-lookup"><span data-stu-id="7d9e5-107">In addition, because of index usage, case-sensitivity and similar aspects can have a far-reaching impact on query performance: while it may be tempting to use `string.Lower` to force a case-insensitive comparison in a case-sensitive database, doing so may prevent your application from using indexes.</span></span> <span data-ttu-id="7d9e5-108">На этой странице подробно описано, как настроить чувствительность к регистру или, как правило, параметры сортировки, а также как это сделать с помощью эффективного способа, не нарушая производительность запросов.</span><span class="sxs-lookup"><span data-stu-id="7d9e5-108">This page details how to configure case sensitivity, or more generally, collations, and how to do so in an efficient way without compromising query performance.</span></span>

## <a name="introduction-to-collations"></a><span data-ttu-id="7d9e5-109">Общие сведения о параметрах сортировки</span><span class="sxs-lookup"><span data-stu-id="7d9e5-109">Introduction to collations</span></span>

<span data-ttu-id="7d9e5-110">Фундаментальным понятием обработки текста является *Сортировка*, которая представляет собой набор правил, определяющих порядок упорядочения текстовых значений и их сравнение на равенство.</span><span class="sxs-lookup"><span data-stu-id="7d9e5-110">A fundamental concept in text processing is the *collation*, which is a set of rules determining how text values are ordered and compared for equality.</span></span> <span data-ttu-id="7d9e5-111">Например, хотя параметры сортировки без учета регистра не учитывают различия между буквами верхнего и нижнего регистра в целях сравнения на равенство, параметры сортировки с учетом регистра не применяются.</span><span class="sxs-lookup"><span data-stu-id="7d9e5-111">For example, while a case-insensitive collation disregards differences between upper- and lower-case letters for the purposes of equality comparison, a case-sensitive collation does not.</span></span> <span data-ttu-id="7d9e5-112">Однако, так как учет регистра учитывает язык и региональные параметры (например `i` , и `I` представляет другую букву в турецком языке), существует несколько параметров сортировки без учета регистра, каждый из которых имеет собственный набор правил.</span><span class="sxs-lookup"><span data-stu-id="7d9e5-112">However, since case-sensitivity is culture-sensitive (e.g. `i` and `I` represent different letter in Turkish), there exist multiple case-insensitive collations, each with its own set of rules.</span></span> <span data-ttu-id="7d9e5-113">Область применения параметров сортировки также выходит за рамки учета регистра и других аспектов символьных данных. Например, на немецком языке он иногда (но не всегда) желательно рассматривать `ä` и `ae` как идентичный.</span><span class="sxs-lookup"><span data-stu-id="7d9e5-113">The scope of collations also extends beyond case-sensitivity, to other aspects of character data; in German, for example, it is sometimes (but not always) desirable to treat `ä` and `ae` as identical.</span></span> <span data-ttu-id="7d9e5-114">Наконец, параметры сортировки также определяют порядок *упорядочения*текстовых значений: а немецкая `ä` — `a` в конце алфавита.</span><span class="sxs-lookup"><span data-stu-id="7d9e5-114">Finally, collations also define how text values are *ordered*: while German places `ä` after `a`, Swedish places it at the end of the alphabet.</span></span>

<span data-ttu-id="7d9e5-115">Все текстовые операции в базе данных используют параметры сортировки — независимо от того, следует ли явно или неявно определить, как операция сравнивает строки и упорядочивает их.</span><span class="sxs-lookup"><span data-stu-id="7d9e5-115">All text operations in a database use a collation - whether explicitly or implicitly - to determine how the operation compares and orders strings.</span></span> <span data-ttu-id="7d9e5-116">Реальный список доступных параметров сортировки и их схем именования зависит от базы данных. в [разделе ниже](#database-specific-information) приведены ссылки на соответствующие страницы документации по различным базам данных.</span><span class="sxs-lookup"><span data-stu-id="7d9e5-116">The actual list of available collations and their naming schemes is database-specific; consult [the section below](#database-specific-information) for links to relevant documentation pages of various databases.</span></span> <span data-ttu-id="7d9e5-117">К счастью, база данных обычно позволяет определять параметры сортировки по умолчанию на уровне базы данных или столбца, а также явно указывать, какие параметры сортировки следует использовать для конкретных операций в запросе.</span><span class="sxs-lookup"><span data-stu-id="7d9e5-117">Fortunately, database do generally allow a default collation to be defined at the database or column level, and to explicitly specify which collation should be use for specific operations in a query.</span></span>

## <a name="database-collation"></a><span data-ttu-id="7d9e5-118">Параметры сортировки баз данных</span><span class="sxs-lookup"><span data-stu-id="7d9e5-118">Database collation</span></span>

<span data-ttu-id="7d9e5-119">В большинстве систем баз данных параметры сортировки по умолчанию определяются на уровне базы данных. Если не переопределено, то эти параметры сортировки неявно применяются ко всем текстовым операциям, происходящим в этой базе данных.</span><span class="sxs-lookup"><span data-stu-id="7d9e5-119">In most database systems, a default collation is defined at the database level; unless overridden, that collation implicitly applies to all text operations occurring within that database.</span></span> <span data-ttu-id="7d9e5-120">Параметры сортировки базы данных обычно задаются во время создания базы данных (с помощью `CREATE DATABASE` инструкции DDL), а если не задано, по умолчанию устанавливается какое-либо значение уровня сервера, определенное во время установки.</span><span class="sxs-lookup"><span data-stu-id="7d9e5-120">The database collation is typically set at database creation time (via the `CREATE DATABASE` DDL statement), and if not specified, defaults to a some server-level value determined at setup time.</span></span> <span data-ttu-id="7d9e5-121">Например, параметры сортировки уровня сервера по умолчанию в SQL Server — это `SQL_Latin1_General_CP1_CI_AS` , без учета регистра, параметры сортировки с учетом диакритических знаков.</span><span class="sxs-lookup"><span data-stu-id="7d9e5-121">For example, the default server-level collation in SQL Server is `SQL_Latin1_General_CP1_CI_AS`, which is a case-insensitive, accent-sensitive collation.</span></span> <span data-ttu-id="7d9e5-122">Хотя системы баз данных, как правило, позволяют изменять параметры сортировки существующей базы данных, это может привести к осложнениям. рекомендуется выбрать параметры сортировки перед созданием базы данных.</span><span class="sxs-lookup"><span data-stu-id="7d9e5-122">Although database systems usually do permit altering the collation of an existing database, doing so can lead to complications; it is recommended to pick a collation before database creation.</span></span>

<span data-ttu-id="7d9e5-123">При использовании EF Core миграции для управления схемой базы данных в `OnModelCreating` методе модели настраивается база данных SQL Server для использования параметров сортировки с учетом регистра.</span><span class="sxs-lookup"><span data-stu-id="7d9e5-123">When using EF Core migrations to manage your database schema, the following in your model's `OnModelCreating` method configures a SQL Server database to use a case-sensitive collation:</span></span>

[!code-csharp[Main](../../../samples/core/Miscellaneous/Collations/Program.cs?range=40)]

## <a name="column-collation"></a><span data-ttu-id="7d9e5-124">Параметры сортировки столбца</span><span class="sxs-lookup"><span data-stu-id="7d9e5-124">Column collation</span></span>

<span data-ttu-id="7d9e5-125">Параметры сортировки также могут быть определены для текстовых столбцов, переопределяя значения по умолчанию для базы данных.</span><span class="sxs-lookup"><span data-stu-id="7d9e5-125">Collations can also be defined on text columns, overriding the database default.</span></span> <span data-ttu-id="7d9e5-126">Это может быть полезно, если в некоторых столбцах необходимо учитывать регистр, а остальная часть базы данных должна учитывать регистр.</span><span class="sxs-lookup"><span data-stu-id="7d9e5-126">This can be useful if certain columns need to be case-insensitive, while the rest of the database needs to be case-sensitive.</span></span>

<span data-ttu-id="7d9e5-127">При использовании EF Core миграций для управления схемой базы данных Следующая настройка столбца для `Name` свойства не учитывает регистр в базе данных, которая в противном случае настроена с учетом регистра:</span><span class="sxs-lookup"><span data-stu-id="7d9e5-127">When using EF Core migrations to manage your database schema, the following configures the column for the `Name` property to be case-insensitive in a database that is otherwise configured to be case-sensitive:</span></span>

[!code-csharp[Main](../../../samples/core/Miscellaneous/Collations/Program.cs?name=OnModelCreating&highlight=6)]

## <a name="explicit-collation-in-a-query"></a><span data-ttu-id="7d9e5-128">Явные параметры сортировки в запросе</span><span class="sxs-lookup"><span data-stu-id="7d9e5-128">Explicit collation in a query</span></span>

<span data-ttu-id="7d9e5-129">В некоторых случаях один и тот же столбец необходимо запрашивать с использованием различных параметров сортировки в разных запросах.</span><span class="sxs-lookup"><span data-stu-id="7d9e5-129">In some cases, the same column needs to be queried using different collations by different queries.</span></span> <span data-ttu-id="7d9e5-130">Например, одному запросу может потребоваться выполнить сравнение столбца с учетом регистра, в то время как другой может потребоваться сравнение с тем же столбцом без учета регистра.</span><span class="sxs-lookup"><span data-stu-id="7d9e5-130">For example, one query may need to perform a case-sensitive comparison on a column, while another may need to perform a case-insensitive comparison on the same column.</span></span> <span data-ttu-id="7d9e5-131">Это можно сделать, явно указав параметры сортировки в самом запросе:</span><span class="sxs-lookup"><span data-stu-id="7d9e5-131">This can be accomplished by explicitly specifying a collation within the query itself:</span></span>

[!code-csharp[Main](../../../samples/core/Miscellaneous/Collations/Program.cs?name=SimpleQueryCollation)]

<span data-ttu-id="7d9e5-132">При этом создается `COLLATE` предложение в SQL-запросе, в котором применяются параметры сортировки с учетом регистра, независимо от параметров сортировки, определенных на уровне столбца или базы данных.</span><span class="sxs-lookup"><span data-stu-id="7d9e5-132">This generates a `COLLATE` clause in the SQL query, which applies a case-sensitive collation regardless of the collation defined at the column or database level:</span></span>

```sql
SELECT [c].[Id], [c].[Name]
FROM [Customers] AS [c]
WHERE [c].[Name] COLLATE SQL_Latin1_General_CP1_CS_AS = N'John'
```

### <a name="explicit-collations-and-indexes"></a><span data-ttu-id="7d9e5-133">Явные параметры сортировки и индексы</span><span class="sxs-lookup"><span data-stu-id="7d9e5-133">Explicit collations and indexes</span></span>

<span data-ttu-id="7d9e5-134">Индексы являются одним из наиболее важных факторов производительности базы данных — запрос, который эффективно работает с индексом, может привести к остановке без этого индекса.</span><span class="sxs-lookup"><span data-stu-id="7d9e5-134">Indexes are one of the most important factors in database performance - a query that runs efficiently with an index can grind to a halt without that index.</span></span> <span data-ttu-id="7d9e5-135">Индексы неявно наследуют параметры сортировки своего столбца; Это означает, что все запросы к столбцу автоматически подходят для использования индексов, определенных в этом столбце, при условии, что в запросе не указаны другие параметры сортировки.</span><span class="sxs-lookup"><span data-stu-id="7d9e5-135">Indexes implicitly inherit the collation of their column; this means that all queries on the column are automatically eligible to use indexes defined on that column - provided that the query doesn't specify a different collation.</span></span> <span data-ttu-id="7d9e5-136">Явное указание параметров сортировки в запросе не позволит этому запросу использовать индекс, определенный для этого столбца, так как параметры сортировки больше не совпадают. Поэтому рекомендуется соблюдать осторожность при использовании этой функции.</span><span class="sxs-lookup"><span data-stu-id="7d9e5-136">Specifying an explicit collation in a query will generally prevent that query from using an index defined on that column, since the collations would no longer match; it is therefore recommended to exercise caution when using this feature.</span></span> <span data-ttu-id="7d9e5-137">Всегда предпочтительнее определить параметры сортировки на уровне столбца (или базы данных), что позволяет всем запросам неявно использовать эти параметры сортировки и преимущества любого индекса.</span><span class="sxs-lookup"><span data-stu-id="7d9e5-137">It is always preferable to define the collation at the column (or database) level, allowing all queries to implicitly use that collation and benefit from any index.</span></span>

<span data-ttu-id="7d9e5-138">Обратите внимание, что некоторые базы данных позволяют определять параметры сортировки при создании индекса (например, PostgreSQL, SQLite).</span><span class="sxs-lookup"><span data-stu-id="7d9e5-138">Note that some databases allow the collation to be defined when creating an index (e.g. PostgreSQL, Sqlite).</span></span> <span data-ttu-id="7d9e5-139">Это позволяет определять несколько индексов в одном столбце, ускоряя операции с различными параметрами сортировки (например, сравнение с учетом регистра и без учета регистра).</span><span class="sxs-lookup"><span data-stu-id="7d9e5-139">This allows multiple indexes to be defined on the same column, speeding up operations with different collations (e.g. both case-sensitive and case-insensitive comparisons).</span></span> <span data-ttu-id="7d9e5-140">Дополнительные сведения см. в документации поставщика базы данных.</span><span class="sxs-lookup"><span data-stu-id="7d9e5-140">Consult your database provider's documentation for more details.</span></span>

> [!WARNING]
> <span data-ttu-id="7d9e5-141">Всегда проверяйте планы запросов запросов и убедитесь, что в критически важных для производительности запросах используются правильные индексы, выполняемые на больших объемах данных.</span><span class="sxs-lookup"><span data-stu-id="7d9e5-141">Always inspect the query plans of your queries, and make sure the proper indexes are being used in performance-critical queries executing over large amounts of data.</span></span> <span data-ttu-id="7d9e5-142">Переопределение чувствительности к регистру в запросе с помощью `EF.Functions.Collate` (или путем вызова `string.ToLower` ) может оказать значительное влияние на производительность приложения.</span><span class="sxs-lookup"><span data-stu-id="7d9e5-142">Overriding case-sensitivity in a query via `EF.Functions.Collate` (or by calling `string.ToLower`) can have a very significant impact on your application's performance.</span></span>

## <a name="translation-of-built-in-net-string-operations"></a><span data-ttu-id="7d9e5-143">Перевод встроенных строковых операций .NET</span><span class="sxs-lookup"><span data-stu-id="7d9e5-143">Translation of built-in .NET string operations</span></span>

<span data-ttu-id="7d9e5-144">В .NET равенство по строкам учитывает регистр по умолчанию: `s1 == s2` выполняет порядковое сравнение, которое требует идентичности строк.</span><span class="sxs-lookup"><span data-stu-id="7d9e5-144">In .NET, string equality is case-sensitive by default: `s1 == s2` performs an ordinal comparison that requires the strings to be identical.</span></span> <span data-ttu-id="7d9e5-145">Поскольку параметры сортировки баз данных по умолчанию могут различаться, и, поскольку для использования индексов желательно простое равенство, EF Core не пытается преобразовать простое равенство в базу данных с учетом регистра. равенство в C# преобразуется непосредственно в равенство SQL, которое может быть или не учитываться с учетом регистра в зависимости от используемой базы данных и ее конфигурации параметров сортировки.</span><span class="sxs-lookup"><span data-stu-id="7d9e5-145">Because the default collation of databases varies, and because it is desirable for simple equality to use indexes, EF Core makes no attempt to translate simple equality to a database case-sensitive operation: C# equality is translated directly to SQL equality, which may or may not be case-sensitive, depending on the specific database in use and its collation configuration.</span></span>

<span data-ttu-id="7d9e5-146">Кроме того, .NET предоставляет перегрузки для [`string.Equals`](https://docs.microsoft.com/dotnet/api/system.string.equals#System_String_Equals_System_String_System_StringComparison_) принятия [`StringComparison`](https://docs.microsoft.com/dotnet/api/system.stringcomparison) перечисления, что позволяет указывать чувствительность к регистру и культуру для сравнения.</span><span class="sxs-lookup"><span data-stu-id="7d9e5-146">In addition, .NET provides overloads of [`string.Equals`](https://docs.microsoft.com/dotnet/api/system.string.equals#System_String_Equals_System_String_System_StringComparison_) accepting a [`StringComparison`](https://docs.microsoft.com/dotnet/api/system.stringcomparison) enum, which allows specifying case-sensitivity and culture for the comparison.</span></span> <span data-ttu-id="7d9e5-147">По разработке EF Core отменяет перевод этих перегрузок в SQL, и попытка использовать их приведет к исключению.</span><span class="sxs-lookup"><span data-stu-id="7d9e5-147">By design, EF Core refrains from translating these overloads to SQL, and attempting to use them will result in an exception.</span></span> <span data-ttu-id="7d9e5-148">В одном случае EF Core не знает, какие параметры сортировки с учетом регистра или без учета регистра следует использовать.</span><span class="sxs-lookup"><span data-stu-id="7d9e5-148">For one thing, EF Core does know not which case-sensitive or case-insensitive collation should be used.</span></span> <span data-ttu-id="7d9e5-149">Что более важно, применение параметров сортировки в большинстве случаев предотвращает использование индексов, значительно влияя на производительность для очень простой и часто используемой конструкции .NET.</span><span class="sxs-lookup"><span data-stu-id="7d9e5-149">More importantly, applying a collation would in most cases prevent index usage, significantly impacting performance for a very basic and commonly-used .NET construct.</span></span> <span data-ttu-id="7d9e5-150">Чтобы принудительно использовать сравнение с учетом регистра или без учета регистра, укажите параметры сортировки явно с помощью, `EF.Functions.Collate` как [описано выше](#explicit-collations-and-indexes).</span><span class="sxs-lookup"><span data-stu-id="7d9e5-150">To force a query to use case-sensitive or case-insensitive comparison, specify a collation explicitly via `EF.Functions.Collate` as [detailed above](#explicit-collations-and-indexes).</span></span>

## <a name="database-specific-information"></a><span data-ttu-id="7d9e5-151">Сведения, относящиеся к базе данных</span><span class="sxs-lookup"><span data-stu-id="7d9e5-151">Database-specific information</span></span>

* <span data-ttu-id="7d9e5-152">[SQL Server документация по параметрам сортировки](https://docs.microsoft.com/sql/relational-databases/collations/collation-and-unicode-support).</span><span class="sxs-lookup"><span data-stu-id="7d9e5-152">[SQL Server documentation on collations](https://docs.microsoft.com/sql/relational-databases/collations/collation-and-unicode-support).</span></span>
* <span data-ttu-id="7d9e5-153">[Документация Microsoft. Data. SQLite по параметрам сортировки](https://docs.microsoft.com/dotnet/standard/data/sqlite/collation).</span><span class="sxs-lookup"><span data-stu-id="7d9e5-153">[Microsoft.Data.Sqlite documentation on collations](https://docs.microsoft.com/dotnet/standard/data/sqlite/collation).</span></span>
* <span data-ttu-id="7d9e5-154">[PostgreSQL документация по параметрам сортировки](https://www.postgresql.org/docs/current/collation.html).</span><span class="sxs-lookup"><span data-stu-id="7d9e5-154">[PostgreSQL documentation on collations](https://www.postgresql.org/docs/current/collation.html).</span></span>
* <span data-ttu-id="7d9e5-155">[Документация MySQL по параметрам сортировки](https://dev.mysql.com/doc/refman/en/charset-general.html).</span><span class="sxs-lookup"><span data-stu-id="7d9e5-155">[MySQL documentation on collations](https://dev.mysql.com/doc/refman/en/charset-general.html).</span></span>
