---
title: Пулы DbContext
description: DbContext пулов в Entity Framework Core
author: rick-anderson
ms.author: riande
ms.date: 9/19/2020
uid: core/miscellaneous/context-pooling
ms.openlocfilehash: 8638c838511be85bd994751b9911b107974dfe2f
ms.sourcegitcommit: 0a25c03fa65ae6e0e0e3f66bac48d59eceb96a5a
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/14/2020
ms.locfileid: "92061961"
---
# <a name="dbcontext-pooling"></a>Создание пулов DbContext

`AddDbContextPool` включает создание пулов `DbContext` экземпляров. Пул контекста может увеличить пропускную способность в крупномасштабных сценариях, таких как веб-серверы, путем повторного использования экземпляров контекста вместо создания новых экземпляров для каждого запроса.

Типичный шаблон в ASP.NET Core приложении, использующем EF Core, включает регистрацию пользовательского <xref:Microsoft.EntityFrameworkCore.DbContext> типа в контейнер [внедрения зависимостей](/aspnet/core/fundamentals/dependency-injection) и получение экземпляров этого типа через параметры конструктора в контроллерах или Razor Pages. При использовании внедрения конструктора для каждого запроса создается новый экземпляр контекста.

<xref:Microsoft.Extensions.DependencyInjection.EntityFrameworkServiceCollectionExtensions.AddDbContextPool%2A> включает пул экземпляров контекста для повторного использования. Чтобы использовать пулы контекста, используйте `AddDbContextPool` метод вместо `AddDbContext` во время регистрации службы:

```csharp
services.AddDbContextPool<BloggingContext>(
    options => options.UseSqlServer(connectionString));
```

Если `AddDbContextPool` используется, то при запросе экземпляра контекста EF сначала проверяет, доступен ли экземпляр в пуле. После завершения обработки запроса любое состояние экземпляра сбрасывается, а сам экземпляр возвращается в пул.

Это концептуально похоже на то, как пулы соединений работают в поставщиках ADO.NET и имеют преимущество при сохранении некоторых затрат на инициализацию экземпляра контекста.

`poolSize`Параметр <xref:Microsoft.Extensions.DependencyInjection.EntityFrameworkServiceCollectionExtensions.AddDbContextPool%2A> задает максимальное число экземпляров, хранящихся в пуле. После этого `poolSize` новые экземпляры контекста не кэшируются, а EF возвращается к поведению без пула, создающего экземпляры по запросу.

## <a name="limitations"></a>Ограничения

Приложения должны быть профилированы и протестированы для демонстрации того, что инициализация контекста является значительной ценой.

`AddDbContextPool` имеет несколько ограничений на то, что может быть сделано в `OnConfiguring` методе контекста.

> [!WARNING]
> Избегайте использования контекстного пула в приложениях, которые поддерживают состояние. Например, закрытые поля в контексте, которые не должны совместно использоваться в запросах. EF Core только сбрасывает состояние, о котором оно известно, перед добавлением экземпляра контекста в пул.

Пул контекста работает путем повторного использования одного и того же экземпляра контекста в запросах. Это означает, что оно эффективно регистрируется как [Singleton](/aspnet/core/fundamentals/dependency-injection#service-lifetimes) в терминах самого экземпляра, чтобы его можно было сохранить.

Контекстное группирование предназначено для сценариев, в которых конфигурация контекста, включая разрешенные службы, фиксируется между запросами. Для случаев, когда требуются службы с заданной [областью](/aspnet/core/fundamentals/dependency-injection#service-lifetimes) или необходимо изменить конфигурацию, не используйте пулы. Повышение производительности при использовании пулов обычно незначительно, за исключением сценариев с высоким уровнем оптимизации.
