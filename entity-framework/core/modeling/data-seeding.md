---
title: Заполнение данных — EF Core
description: Использование заполнения данных для заполнения базы данных начальным набором данных с помощью Entity Framework Core
author: AndriySvyryd
ms.author: ansvyryd
ms.date: 11/02/2018
uid: core/modeling/data-seeding
ms.openlocfilehash: 1d7adbe45c4cbc64a39485c76d8f516e32ffeba5
ms.sourcegitcommit: abda0872f86eefeca191a9a11bfca976bc14468b
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 09/14/2020
ms.locfileid: "90071606"
---
# <a name="data-seeding"></a>Присвоение начальных значений данных

Заполнение данных — это процесс заполнения базы данных начальным набором данных.

Существует несколько способов, которые можно выполнить в EF Core.

* Начальные данные модели
* Настройка миграции вручную
* Пользовательская логика инициализации

## <a name="model-seed-data"></a>Начальные данные модели

> [!NOTE]
> Это новая возможность в EF Core 2.1.

В отличие от EF6, в EF Core данные заполнения могут быть связаны с типом сущности как часть конфигурации модели. Затем EF Core [миграции](xref:core/managing-schemas/migrations/index) могут автоматически вычислять, какие операции вставки, обновления или удаления должны быть применены при обновлении базы данных до новой версии модели.

> [!NOTE]
> Миграция учитывает изменения модели только при определении того, какая операция должна быть выполнена, чтобы получить начальные данные в требуемое состояние. Поэтому любые изменения данных, выполненные за пределами миграции, могут быть потеряны или вызывать ошибку.

В качестве примера вы настроите начальные данные для `Blog` в `OnModelCreating` :

[!code-csharp[BlogSeed](../../../samples/core/Modeling/DataSeeding/DataSeedingContext.cs?name=BlogSeed)]

Чтобы добавить сущности с отношением, необходимо указать значения внешнего ключа:

[!code-csharp[PostSeed](../../../samples/core/Modeling/DataSeeding/DataSeedingContext.cs?name=PostSeed)]

Если тип сущности имеет какие бы то ни было свойства в теневом состоянии, для предоставления значений можно использовать анонимный класс.

[!code-csharp[AnonymousPostSeed](../../../samples/core/Modeling/DataSeeding/DataSeedingContext.cs?name=AnonymousPostSeed)]

Собственные типы сущностей могут быть заполнены подобным образом:

[!code-csharp[OwnedTypeSeed](../../../samples/core/Modeling/DataSeeding/DataSeedingContext.cs?name=OwnedTypeSeed)]

См. [полный пример проекта](https://github.com/dotnet/EntityFramework.Docs/tree/master/samples/core/Modeling/DataSeeding) для получения дополнительных контекстов.

После добавления данных в модель для применения изменений следует использовать [миграции](xref:core/managing-schemas/migrations/index) .

> [!TIP]
> Если необходимо применить миграции в рамках автоматизированного развертывания, можно [создать скрипт SQL](xref:core/managing-schemas/migrations/index#generate-sql-scripts) , который можно просмотреть перед выполнением.

Кроме того, можно использовать `context.Database.EnsureCreated()` для создания новой базы данных, содержащей начальные данные, например для тестовой базы данных или при использовании поставщика в памяти или любой базы данных, не являющейся реляционной. Обратите внимание, что если база данных уже существует, `EnsureCreated()` не будет обновлять схему или начальные данные в базе данных. Для реляционных баз данных не следует вызывать, `EnsureCreated()` Если планируется использовать миграции.

### <a name="limitations-of-model-seed-data"></a>Ограничения данных начального значения модели

Этот тип данных начального значения управляется миграцией, а скрипт для обновления данных, которые уже находятся в базе данных, должен быть создан без подключения к базе данных. Это накладывает некоторые ограничения:

* Значение первичного ключа необходимо указать, даже если оно обычно создается базой данных. Он будет использоваться для обнаружения изменений данных между миграции.
* Ранее заполненные данные будут удалены, если первичный ключ изменяется каким-либо образом.

Поэтому эта функция наиболее полезна для статических данных, которые не должны изменяться за пределами миграции и не зависят от каких-либо других элементов в базе данных, например ZIP-кодов.

Если сценарий включает в себя любое из следующих действий, рекомендуется использовать настраиваемую логику инициализации, описанную в последнем разделе.

* Временные данные для тестирования
* Данные, зависящие от состояния базы данных
* Данные, которым требуются значения ключей, создаваемые базой данных, включая сущности, которые используют альтернативные ключи в качестве удостоверения.
* Данные, для которых требуется пользовательское преобразование (которое не обрабатывается при [преобразовании значений](xref:core/modeling/value-conversions)), например, хэширование паролей
* Данные, требующие вызовов к внешнему API, такие как ASP.NET Coreные роли удостоверения и создание пользователей

## <a name="manual-migration-customization"></a>Настройка миграции вручную

При добавлении миграции изменения данных, указанных в, `HasData` преобразуются в вызовы методов `InsertData()` , `UpdateData()` и `DeleteData()` . Одним из способов обхода некоторых ограничений `HasData` является ручное добавление этих вызовов или [пользовательских операций](xref:core/managing-schemas/migrations/operations) в процесс миграции.

[!code-csharp[CustomInsert](../../../samples/core/Modeling/DataSeeding/Migrations/20181102235626_Initial.cs?name=CustomInsert)]

## <a name="custom-initialization-logic"></a>Пользовательская логика инициализации

Простой и эффективный способ выполнения заполнения данных — использовать [`DbContext.SaveChanges()`](xref:core/saving/index) перед началом выполнения основной логики приложения.

[!code-csharp[Main](../../../samples/core/Modeling/DataSeeding/Program.cs?name=CustomSeeding)]

> [!WARNING]
> Код заполнения не должен быть частью обычного выполнения приложения, так как это может привести к проблемам параллелизма при запуске нескольких экземпляров и потребовать от приложения разрешения на изменение схемы базы данных.

В зависимости от ограничений развертывания код инициализации можно выполнять различными способами:

* Локальное выполнение приложения инициализации
* Развертывание приложения инициализации с помощью основного приложения, вызов процедуры инициализации и отключение или удаление приложения инициализации.

Обычно это можно автоматизировать с помощью [профилей публикации](/aspnet/core/host-and-deploy/visual-studio-publish-profiles).
