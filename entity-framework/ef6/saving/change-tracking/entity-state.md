---
title: Работа с состояниями сущностей — EF6
description: Работа с состояниями сущностей в Entity Framework 6
author: divega
ms.date: 10/23/2016
uid: ef6/saving/change-tracking/entity-state
ms.openlocfilehash: 88c1b67b3eda02e79f7d10d5e46fdd3566361634
ms.sourcegitcommit: abda0872f86eefeca191a9a11bfca976bc14468b
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 09/14/2020
ms.locfileid: "90073773"
---
# <a name="working-with-entity-states"></a>Работа с состояниями сущностей
В этом разделе рассматривается добавление и присоединение сущностей к контексту и то, как Entity Framework обрабатывает их во время вызова метода SaveChanges.
Entity Framework следит за отслеживанием состояния сущностей, когда они подключены к контексту, но в отключенных или N-ярусных сценариях EF можно сообщить о том, в каком состоянии будут находиться ваши сущности.
Методы, представленные в этом разделе, также применимы к моделям, созданным с помощью Code First и конструктора EF.  

## <a name="entity-states-and-savechanges"></a>Состояния сущностей и SaveChanges

Сущность может находиться в одном из пяти состояний, как определено в перечислении EntityState. Возможны следующие состояния:  

- Добавлено: сущность отслеживается контекстом, но еще не существует в базе данных.  
- Без изменений: сущность отслеживается контекстом и существует в базе данных, а значения ее свойств не изменяются из значений в базе данных.  
- Изменено: сущность отслеживается контекстом и существует в базе данных, а некоторые или все значения ее свойств были изменены.  
- Удалено: сущность отслеживается контекстом и существует в базе данных, но была помечена для удаления из базы данных при следующем вызове SaveChanges  
- Отсоединено: сущность не отслеживается контекстом  

SaveChanges выполняет различные операции с сущностями в различных состояниях:  

- Неизмененные сущности не затрагиваются функцией SaveChanges. Обновления не отправляются в базу данных для сущностей в неизмененном состоянии.  
- Добавленные сущности вставляются в базу данных, а затем становятся неизменными при возврате SaveChanges.  
- Измененные сущности обновляются в базе данных, а затем становятся неизменными при возврате SaveChanges.  
- Удаленные сущности удаляются из базы данных и затем отсоединяются из контекста.  

В следующих примерах показаны способы изменения состояния сущности или графа сущностей.  

## <a name="adding-a-new-entity-to-the-context"></a>Добавление новой сущности в контекст  

Новую сущность можно добавить в контекст, вызвав метод Add для DbSet.
При этом сущность помещается в добавленное состояние, что означает, что она будет вставлена в базу данных при следующем вызове метода SaveChanges.
Пример:  

``` csharp
using (var context = new BloggingContext())
{
    var blog = new Blog { Name = "ADO.NET Blog" };
    context.Blogs.Add(blog);
    context.SaveChanges();
}
```  

Другим способом добавления новой сущности в контекст является изменение ее состояния на "Добавлено". Пример:  

``` csharp
using (var context = new BloggingContext())
{
    var blog = new Blog { Name = "ADO.NET Blog" };
    context.Entry(blog).State = EntityState.Added;
    context.SaveChanges();
}
```  

Наконец, можно добавить новую сущность в контекст, применив ее к другой сущности, которая уже отслеживается.
Это может быть вызвано добавлением новой сущности к свойству навигации коллекции другой сущности или установкой свойства навигации по ссылке другой сущности для указания на новую сущность. Пример:  

``` csharp
using (var context = new BloggingContext())
{
    // Add a new User by setting a reference from a tracked Blog
    var blog = context.Blogs.Find(1);
    blog.Owner = new User { UserName = "johndoe1987" };

    // Add a new Post by adding to the collection of a tracked Blog
    blog.Posts.Add(new Post { Name = "How to Add Entities" });

    context.SaveChanges();
}
```  

Обратите внимание, что для всех этих примеров, если добавляемая сущность содержит ссылки на другие сущности, которые еще не были отслеживаемы, эти новые сущности также будут добавлены в контекст и будут вставлены в базу данных при следующем вызове метода SaveChanges.  

## <a name="attaching-an-existing-entity-to-the-context"></a>Присоединение существующей сущности к контексту  

Если у вас есть сущность, которая уже существует в базе данных, но в настоящий момент не отслеживается контекстом, можно указать контексту отслеживание сущности с помощью метода Attach в DbSet. Сущность будет находиться в неизмененном состоянии в контексте. Пример:  

``` csharp
var existingBlog = new Blog { BlogId = 1, Name = "ADO.NET Blog" };

using (var context = new BloggingContext())
{
    context.Blogs.Attach(existingBlog);

    // Do some more work...  

    context.SaveChanges();
}
```  

Обратите внимание, что в базу данных не вносятся изменения, если метод SaveChanges вызывается без выполнения других манипуляций с присоединенной сущностью. Это вызвано тем, что сущность находится в неизмененном состоянии.  

Еще один способ присоединить существующую сущность к контексту — изменить его состояние на без изменений. Пример:  

``` csharp
var existingBlog = new Blog { BlogId = 1, Name = "ADO.NET Blog" };

using (var context = new BloggingContext())
{
    context.Entry(existingBlog).State = EntityState.Unchanged;

    // Do some more work...  

    context.SaveChanges();
}
```  

Обратите внимание, что в обоих примерах, если присоединяемая сущность имеет ссылки на другие сущности, которые еще не отслеживаемы, эти новые сущности также будут присоединены к контексту в неизмененном состоянии.  

## <a name="attaching-an-existing-but-modified-entity-to-the-context"></a>Присоединение существующей, но измененной сущности к контексту  

Если у вас есть сущность, которая уже существует в базе данных, но изменения могли быть внесены, можно указать контексту присоединить сущность и присвоить ей состояние Modified.
Пример:  

``` csharp
var existingBlog = new Blog { BlogId = 1, Name = "ADO.NET Blog" };

using (var context = new BloggingContext())
{
    context.Entry(existingBlog).State = EntityState.Modified;

    // Do some more work...  

    context.SaveChanges();
}
```  

При изменении состояния на измененные все свойства сущности будут помечены как измененные, а все значения свойств будут отправляться в базу данных при вызове метода SaveChanges.  

Обратите внимание, что если присоединяемая сущность содержит ссылки на другие сущности, которые еще не отслеживаемы, то эти новые сущности будут присоединены к контексту в неизмененном состоянии — они не будут автоматически изменены.
При наличии нескольких сущностей, которые необходимо пометить как измененные, необходимо задать состояние для каждой из этих сущностей по отдельности.  

## <a name="changing-the-state-of-a-tracked-entity"></a>Изменение состояния отслеживающей сущности  

Состояние сущности, которая уже отслеживается, можно изменить, задав свойство State для его записи. Пример:  

``` csharp
var existingBlog = new Blog { BlogId = 1, Name = "ADO.NET Blog" };

using (var context = new BloggingContext())
{
    context.Blogs.Attach(existingBlog);
    context.Entry(existingBlog).State = EntityState.Unchanged;

    // Do some more work...  

    context.SaveChanges();
}
```  

Обратите внимание, что вызов Add или Attach для сущности, которая уже зарегистрирована, может также использоваться для изменения состояния сущности. Например, вызов attach для сущности, которая в данный момент находится в состоянии добавления, изменит свое состояние на без изменений.  

## <a name="insert-or-update-pattern"></a>Вставка или обновление шаблона  

Распространенным шаблоном для некоторых приложений является добавление сущности как новой (в результате вставки базы данных) или присоединение сущности в качестве существующей и пометка ее как измененной (в результате обновления базы данных) в зависимости от значения первичного ключа.
Например, при использовании сформированных в базе данных целочисленных первичных ключей обычно считается, что сущность с нулевым ключом не является новой и сущность с ненулевым ключом уже существует.
Этот шаблон можно достичь, задав состояние сущности на основе проверки значения первичного ключа. Пример:  

``` csharp
public void InsertOrUpdate(Blog blog)
{
    using (var context = new BloggingContext())
    {
        context.Entry(blog).State = blog.BlogId == 0 ?
                                   EntityState.Added :
                                   EntityState.Modified;

        context.SaveChanges();
    }
}
```  

Обратите внимание, что при изменении состояния на измененные все свойства сущности будут помечены как измененные, а все значения свойств будут отправляться в базу данных при вызове метода SaveChanges.  
