---
title: Автоматическая Code First Migrations-EF6
description: Автоматическое Code First Migrations в Entity Framework 6
author: ajcvickers
ms.date: 10/23/2016
uid: ef6/modeling/code-first/migrations/automatic
ms.openlocfilehash: 8152cdf642258a30d98f3750bf1ca4ccd2859978
ms.sourcegitcommit: 0a25c03fa65ae6e0e0e3f66bac48d59eceb96a5a
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/14/2020
ms.locfileid: "92066412"
---
# <a name="automatic-code-first-migrations"></a>Автоматическое Code First Migrations
Автоматическая миграция позволяет использовать Code First Migrations без файла кода в проекте для каждого внесенного изменения. Не все изменения могут быть применены автоматически. Например, для переименования столбцов требуется использовать перенос на основе кода.

> [!NOTE]
> В этой статье предполагается, что вы умеете использовать Code First Migrations в основных сценариях. В противном случае необходимо прочитать [Code First migrations](xref:ef6/modeling/code-first/migrations/index) , прежде чем продолжить.

## <a name="recommendation-for-team-environments"></a>Рекомендации для сред группы

Можно использовать автоматическую миграцию и перенос на основе кода, но это не рекомендуется делать в сценариях групповой разработки. Если вы являетесь членом группы разработчиков, использующих систему управления версиями, следует использовать исключительно автоматическую миграцию или только переносы на основе кода. Учитывая ограничения автоматической миграции, мы рекомендуем использовать миграцию на основе кода в средах группы.

## <a name="building-an-initial-model--database"></a>Привязка начальной модели и базы данных

Прежде чем мы начнем использовать миграции, нам потребуется проект и модель Code First, с которой мы будем работать. В этом пошаговом руководстве мы собираемся использовать каноническую модель **Blog** и **Post**.

-   Создание нового консольного приложения **мигратионсаутоматикдемо**
-   Добавьте последнюю версию пакета NuGet **EntityFramework** в проект.
    -   **Средства —&gt; Диспетчер пакетов библиотеки —&gt; Консоль диспетчера пакетов**
    -   Запустите команду **EntityFramework Install-Package**
-   Добавьте файл **Model.cs** с кодом, показанным ниже. Этот код определяет один класс **Blog**, составляющий нашу модель предметной области, и класс **BlogContext**, который будет нашим контекстом EF Code First.

  ``` csharp
      using System.Data.Entity;
      using System.Collections.Generic;
      using System.ComponentModel.DataAnnotations;
      using System.Data.Entity.Infrastructure;

      namespace MigrationsAutomaticDemo
      {
          public class BlogContext : DbContext
          {
              public DbSet<Blog> Blogs { get; set; }
          }

          public class Blog
          {
              public int BlogId { get; set; }
              public string Name { get; set; }
          }
      }
  ```

-   Теперь, когда у нас есть модель, пора использовать ее для доступа к данным. Внесите в файл **Program.cs** приведенный ниже код.

  ``` csharp
      using System;
      using System.Collections.Generic;
      using System.Linq;
      using System.Text;

      namespace MigrationsAutomaticDemo
      {
          class Program
          {
              static void Main(string[] args)
              {
                  using (var db = new BlogContext())
                  {
                      db.Blogs.Add(new Blog { Name = "Another Blog " });
                      db.SaveChanges();

                      foreach (var blog in db.Blogs)
                      {
                          Console.WriteLine(blog.Name);
                      }
                  }

                  Console.WriteLine("Press any key to exit...");
                  Console.ReadKey();
              }
          }
      }
  ```

-   Запустите приложение, и вы увидите, что база данных **мигратионсаутоматиккодедемо. BlogContext** создана.

    ![LocalDB базы данных](~/ef6/media/databaselocaldb.png)

## <a name="enabling-migrations"></a>Включение миграций

Пора внести дополнительные изменения в нашу модель.

-   Давайте внесем в класс Blog свойство Url.

``` csharp
    public string Url { get; set; }
```

Если бы вы запустили приложение снова, оно выдало бы исключение InvalidOperationException с сообщением: *Модель, поддерживающая контекст BlogContext, изменилась с момента создания базы данных. Попробуйте обновить базу данных с помощью Code First Migrations (* [ *http://go.microsoft.com/fwlink/?LinkId=238269* ](https://go.microsoft.com/fwlink/?LinkId=238269) *).*

Как видно из исключения, пора приступить к использованию Code First Migrations. Поскольку мы хотим использовать автоматические миграции, мы будем указывать параметр **– енаблеаутоматикмигратионс** .

-   Выполните команду **Enable-migrations – енаблеаутоматикмигратионс** в консоли диспетчера пакетов. Эта команда добавила в наш проект папку **migrations** . Эта новая папка содержит один файл:

-   **Класс конфигурации.** Этот класс позволяет настраивать поведение миграций для контекста. В этом пошаговом руководстве мы будем просто использовать конфигурацию по умолчанию.
    *Поскольку имеется только один контекст Code First в проекте, Enable-Migrations автоматически заполняет тип контекста, к которому относится эта конфигурация.*

 

## <a name="your-first-automatic-migration"></a>Первая автоматическая миграция

Вам нужно знать о двух основных командах Code First Migrations.

-   **Add-Migration** будет автоматически формировать следующую миграцию на основе изменений, внесенных в модель с момента создания последней миграции.
-   **Update-Database** будет применять ожидающие обработки миграции к базе данных.

Мы будем избегать использования Add-Migration (если нам не нужно) и сосредоточиться на том, чтобы позволить Code First Migrations автоматически рассчитывать и применять изменения. Мы используем **Обновление базы данных** , чтобы получить Code First migrations для отправки изменений в нашу модель (новое свойство **Blog. ur**l) в базу данных.

-   Выполните команду **обновления базы данных** в консоли диспетчера пакетов.

База данных **мигратионсаутоматикдемо. BlogContext** теперь обновляется для включения столбца **URL-адреса** в таблицу **blogs** .

 

## <a name="your-second-automatic-migration"></a>Вторая автоматическая миграция

Сделаем еще одно изменение и позвольте Code First Migrations автоматически отправлять изменения в базу данных для нас.

-   Также добавим новый класс **Post**.

``` csharp
    public class Post
    {
        public int PostId { get; set; }
        [MaxLength(200)]
        public string Title { get; set; }
        public string Content { get; set; }

        public int BlogId { get; set; }
        public Blog Blog { get; set; }
    }
```

-   Еще мы добавим коллекцию **Posts** в класс **Blog**, чтобы создать второй конец связи между **Blog** и **Post**.

``` csharp
    public virtual List<Post> Posts { get; set; }
```

Теперь используйте **Обновление базы данных** , чтобы обновить базу данных в актуальном состоянии. Давайте укажем флаг **–Verbose**, чтобы вы могли видеть SQL, который выполняет Code First Migrations.

-   Запустите команду **Update-Database –Verbose** в консоли диспетчера пакетов.

## <a name="adding-a-code-based-migration"></a>Добавление переноса на основе кода

Теперь давайте взглянем на то, что мы можем использовать для переноса на основе кода.

-   Давайте добавим свойство **рейтинга** к классу **Blog** .

``` csharp
    public int Rating { get; set; }
```

Для принудительной отправки этих изменений в базу данных можно просто выполнить **Обновление базы данных** . Тем не менее мы добавляем в столбец, не допускающий значения NULL, в столбце **рейтинг** , если в таблице есть данные, им будет назначено значение CLR по умолчанию для нового столбца (оценка — целое число, то есть значение **0**). Но нам нужно указать значение по умолчанию **3**, чтобы существующие строки в таблице **Blogs** начинались с неплохой оценки.
Давайте воспользуемся командой Add-Migration, чтобы записать это изменение в перенос на основе кода, чтобы мы могли изменить его. С помощью команды **Add-Migration** можно присвоить имя миграции. Давайте просто вызываем наш **аддблогратинг**.

-   Выполните команду **Add-Migration аддблогратинг** в консоли диспетчера пакетов.
-   В папке **migrations** теперь появилась новая **аддблогратинг** миграция. Имя файла миграции предварительно исправлено с меткой времени, помогающей в упорядочении. Давайте изменим созданный код, указав значение по умолчанию 3 для блога. рейтинг (строка 10 в приведенном ниже коде).

*Миграция также имеет файл кода программной части, который фиксирует некоторые метаданные. Эти метаданные позволяют Code First Migrations реплицировать автоматические миграции, выполненные до этой миграции на основе кода. Это важно, если другой разработчик хочет выполнить наши миграции или время развертывания приложения.*

``` csharp
    namespace MigrationsAutomaticDemo.Migrations
    {
        using System;
        using System.Data.Entity.Migrations;

        public partial class AddBlogRating : DbMigration
        {
            public override void Up()
            {
                AddColumn("Blogs", "Rating", c => c.Int(nullable: false, defaultValue: 3));
            }

            public override void Down()
            {
                DropColumn("Blogs", "Rating");
            }
        }
    }
```

Измененная миграция выглядит прекрасно, так что давайте обновим ее с помощью команды **Update-Database**.

-   Выполните команду **обновления базы данных** в консоли диспетчера пакетов.

## <a name="back-to-automatic-migrations"></a>Назад к автоматическим миграции

Теперь мы можем вернуться к автоматическому переходу на более простые изменения. Code First Migrations будет выполнять автоматические миграции и перенос на основе кода в правильном порядке на основе метаданных, которые он хранит в файле кода программной части для каждой миграции на основе кода.

-   Давайте добавим в нашу модель свойство POST. abstract.

``` csharp
    public string Abstract { get; set; }
```

Теперь можно использовать **Обновление базы данных** , чтобы получить Code First migrations для отправки этого изменения в базу данных с помощью автоматической миграции.

-   Выполните команду **обновления базы данных** в консоли диспетчера пакетов.

## <a name="summary"></a>Итоги

В этом пошаговом руководстве вы узнали, как использовать автоматические миграции для отправки изменений модели в базу данных. Кроме того, вы узнали, как сформировать шаблоны и выполнять переносы на основе кода между автоматической миграцией, когда требуется больший контроль.
