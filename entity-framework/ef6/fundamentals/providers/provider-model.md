---
title: Модель поставщика Entity Framework 6 — EF6
description: Модель поставщика Entity Framework 6 в Entity Framework 6
author: divega
ms.date: 06/27/2018
uid: ef6/fundamentals/providers/provider-model
ms.openlocfilehash: 4fc45ba5fe916253be348182196be236729d685d
ms.sourcegitcommit: abda0872f86eefeca191a9a11bfca976bc14468b
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 09/14/2020
ms.locfileid: "90074020"
---
# <a name="the-entity-framework-6-provider-model"></a>Модель поставщика Entity Framework 6

Модель поставщика Entity Framework позволяет использовать Entity Framework с различными типами серверов баз данных. Например, один поставщик можно подключить, чтобы разрешить использование EF для Microsoft SQL Server, а другой поставщик можно подключить, чтобы разрешить использование EF для Microsoft SQL Server Compact Edition. Поставщики EF6, о которых мы осведомлены, можно найти на странице [поставщиков Entity Framework](xref:ef6/fundamentals/providers/index) .

Для того, чтобы EF взаимодействовал с поставщиками, были необходимы некоторые изменения, чтобы платформа EF была выпущена в рамках лицензии с открытым исходным кодом. Эти изменения потребует перестроения поставщиков EF для сборок EF6 вместе с новыми механизмами регистрации поставщика.

## <a name="rebuilding"></a>Перестроение

При использовании EF6 основной код, который ранее был частью .NET Framework, теперь поставляется как сборки с нестандартным доступом (OOB). Сведения о том, как создавать приложения для EF6, можно найти на странице [Обновление приложений для EF6](xref:ef6/what-is-new/upgrading-to-ef6) . Поставщики также потребуется перестраивать, используя эти инструкции.

## <a name="provider-types-overview"></a>Общие сведения о типах поставщиков

Поставщик EF представляет собой коллекцию служб, зависящих от поставщика, определенных типами CLR, от которых эти службы расширяются (для базового класса) или реализуют (для интерфейса). Две из этих служб являются фундаментальными и необходимы для правильной работы EF. Другие являются необязательными и должны быть реализованы только в том случае, если требуются определенные функциональные возможности и/или реализации по умолчанию для этих служб не работают для целевого сервера базы данных.

## <a name="fundamental-provider-types"></a>Основные типы поставщиков

### <a name="dbproviderfactory"></a>DbProviderFactory

EF зависит от наличия типа, производного от [System. Data. Common. DbProviderFactory](https://msdn.microsoft.com/library/system.data.common.dbproviderfactory.aspx) , для выполнения всех низкоуровневых операций доступа к базе данных. DbProviderFactory на самом деле не является частью EF, но является классом в .NET Framework, который обслуживает точку входа для поставщиков ADO.NET, которые могут использоваться EF, другими O/RMs или напрямую приложением для получения экземпляров соединений, команд, параметров и других абстракций ADO.NET в независимом от поставщика виде. Дополнительные сведения о DbProviderFactory можно найти в [документации MSDN по ADO.NET](https://msdn.microsoft.com/library/a6cd7c08.aspx).

### <a name="dbproviderservices"></a>DbProviderServices

EF зависит от наличия типа, производного от DbProviderServices, для предоставления дополнительных функциональных возможностей, необходимых EF поверх функциональности, уже предоставленной поставщиком ADO.NET. В более ранних версиях EF класс DbProviderServices был частью .NET Framework и обнаружен в пространстве имен System. Data. Common. Начиная с EF6 этот класс теперь является частью EntityFramework.dll и находится в пространстве имен System. Data. Entity. Core. Common.

Дополнительные сведения об основных функциях реализации DbProviderServices можно найти на [сайте MSDN](https://msdn.microsoft.com/library/ee789835.aspx). Однако обратите внимание, что во время написания этих сведений не обновляется для EF6, хотя большая часть концепций все еще действительна. Реализации SQL Server и SQL Server Compact DbProviderServices также возвращаются в [базу кода с открытым исходным кодом](https://github.com/aspnet/EntityFramework6/) и могут служить полезными ссылками для других реализаций.

В более ранних версиях EF используемая реализация DbProviderServices была получена непосредственно от поставщика ADO.NET. Это было сделано путем приведения DbProviderFactory к IServiceProvider и вызова метода «услуга». Это тесно связывает поставщик EF с DbProviderFactory. Эта связь блокирует связь EF от .NET Framework и, следовательно, для EF6 была удалена эта тесная связь, и реализация DbProviderServices теперь зарегистрирована непосредственно в файле конфигурации приложения или в конфигурации на основе кода, как описано в разделе _Регистрация DbProviderServices_ ниже.

## <a name="additional-services"></a>Дополнительные службы

Помимо основных служб, описанных выше, также существует множество других служб, используемых EF, которые либо всегда, либо иногда относятся к конкретному поставщику. Реализации по умолчанию для этих служб, зависящие от поставщика, могут предоставляться реализацией DbProviderServices. Приложения также могут переопределять реализации этих служб или предоставлять реализации, если тип DbProviderServices не предоставляет значение по умолчанию. Это подробно описано в разделе _разрешение дополнительных служб_ ниже.

Ниже перечислены дополнительные типы служб, которые поставщик может представлять интерес для поставщика. Дополнительные сведения о каждом из этих типов служб можно найти в документации по API.

### <a name="idbexecutionstrategy"></a>IDbExecutionStrategy

Это необязательная служба, позволяющая поставщику реализовать повторные попытки или другое поведение при выполнении запросов и команд в базе данных. Если реализация не предоставлена, EF будет просто выполнять команды и распространять все возникшие исключения. Для SQL Server эта служба используется для предоставления политики повтора, которая особенно полезна при запуске на облачных серверах баз данных, таких как SQL Azure.

### <a name="idbconnectionfactory"></a>идбконнектионфактори

Это необязательная служба, позволяющая поставщику создавать объекты DbConnection по соглашению, если задано только имя базы данных. Обратите внимание, что хотя эта служба может быть разрешена реализацией DbProviderServices, которая имеется в EF 4,1 и может быть явно задана в файле конфигурации или в коде. Поставщик может получить возможность разрешить эту службу, только если она зарегистрирована как поставщик по умолчанию (см. _поставщик по умолчанию_ ниже) и если фабрика соединений по умолчанию не задана в других местах.

### <a name="dbspatialservices"></a>дбспатиалсервицес

Это необязательные службы, позволяющие поставщику добавить поддержку пространственных и геометрических типов географических объектов. Чтобы приложение использовало EF с пространственными типами, необходимо предоставить реализацию этой службы. Дбсптиалсервицес запрашивается двумя способами. Во-первых, пространственные службы, зависящие от поставщика, запрашиваются с помощью объекта Дбпровидеринфо (который содержит инвариантное имя и токен манифеста) в качестве ключа. Во вторых, Дбспатиалсервицес может запрашиваться без ключа. Используется для разрешения "глобального пространственного поставщика", который используется при создании изолированных типов заданное DbGeography или заданное DbGeometry.

### <a name="migrationsqlgenerator"></a>мигратионсклженератор

Это необязательная служба, позволяющая использовать миграции EF для создания SQL-кода, используемого при создании и изменении схем базы данных, Code First. Для поддержки миграции требуется реализация. Если реализация предоставлена, она также будет использоваться при создании баз данных с помощью инициализаторов баз данных или метода Database. Create.

### <a name="funcdbconnection-string-historycontextfactory"></a>Func<DbConnection, String, Хисториконтекстфактори>

Это необязательная служба, позволяющая поставщику настроить сопоставление Хисториконтекст с `__MigrationHistory` таблицей, используемой при миграции EF. Хисториконтекст — это Code First DbContext. его можно настроить с помощью обычного API-интерфейса Fluent, чтобы изменить такие параметры, как имя таблицы и спецификации сопоставления столбцов. Реализация по умолчанию этой службы, возвращаемая EF для всех поставщиков, может работать для данного сервера базы данных, если все сопоставления таблиц и столбцов по умолчанию поддерживаются этим поставщиком. В этом случае поставщику не требуется предоставлять реализацию этой службы.

### <a name="idbproviderfactoryresolver"></a>идбпровидерфакториресолвер

Это необязательная служба для получения правильного DbProviderFactory из данного объекта DbConnection. Реализация по умолчанию этой службы, возвращаемая EF для всех поставщиков, предназначена для работы со всеми поставщиками. Однако при работе в .NET 4 DbProviderFactory не является общедоступным из одного, если его Дбконнектионс. Таким образом, EF использует некоторые эвристические методы для поиска найденных поставщиков в зарегистрированных поставщиках. Некоторые поставщики могут завершиться ошибкой, и в таких ситуациях поставщик должен предоставить новую реализацию.

## <a name="registering-dbproviderservices"></a>Регистрация DbProviderServices

Используемая реализация DbProviderServices может быть зарегистрирована либо в файле конфигурации приложения (app.config или web.config), либо с помощью конфигурации на основе кода. В любом случае при регистрации в качестве ключа используется "инвариантное имя поставщика". Это позволяет регистрировать и использовать несколько поставщиков в одном приложении. Инвариантное имя, используемое для регистраций EF, совпадает с инвариантным именем, используемым для регистрации поставщика ADO.NET и строк подключения. Например, для SQL Server используется инвариантное имя System. Data. SqlClient.

### <a name="config-file-registration"></a>Регистрация в файле конфигурации

Используемый тип DbProviderServices регистрируется в качестве элемента поставщика в списке поставщиков раздела entityFramework файла конфигурации приложения. Пример:

``` xml
<entityFramework>
  <providers>
    <provider invariantName="My.Invariant.Name" type="MyProvider.MyProviderServices, MyAssembly" />
  </providers>
</entityFramework>
```

Строка _типа_ должна представлять собой имя типа с указанием сборки для используемой реализации DbProviderServices.

### <a name="code-based-registration"></a>Регистрация на основе кода

Начиная с поставщиков EF6, можно также регистрироваться с помощью кода. Это позволяет использовать поставщик EF без каких бы то ни было изменений в файле конфигурации приложения. Чтобы использовать конфигурацию на основе кода, приложение должно создать класс DbConfiguration, как описано в [документации по настройке на основе кода](https://msdn.com/data/jj680699). Чтобы зарегистрировать поставщик EF, конструктор класса DbConfiguration должен вызвать Сетпровидерсервицес. Пример:

``` csharp
public class MyConfiguration : DbConfiguration
{
    public MyConfiguration()
    {
        SetProviderServices("My.New.Provider", new MyProviderServices());
    }
}
```

## <a name="resolving-additional-services"></a>Разрешение дополнительных служб

Как упоминалось выше в разделе _Обзор типов поставщиков_ , класс DbProviderServices можно также использовать для разрешения дополнительных служб. Это возможно, поскольку DbProviderServices реализует Идбдепенденциресолвер, а каждый зарегистрированный тип DbProviderServices добавляется в качестве сопоставителя по умолчанию. Механизм Идбдпенденциресолвер более подробно описан в разделе [разрешение зависимостей](xref:ef6/fundamentals/configuring/dependency-resolution). Однако нет необходимости понимать все основные понятия в этой спецификации для разрешения дополнительных служб в поставщике.

Наиболее распространенным способом разрешения дополнительных служб для поставщика является вызов DbProviderServices. Адддепенденциресолвер для каждой службы в конструкторе класса DbProviderServices. Например, Склпровидерсервицес (поставщик EF для SQL Server) имеет следующий код для инициализации:

``` csharp
private SqlProviderServices()
{
    AddDependencyResolver(new SingletonDependencyResolver<IDbConnectionFactory>(
        new SqlConnectionFactory()));

    AddDependencyResolver(new ExecutionStrategyResolver<DefaultSqlExecutionStrategy>(
        "System.data.SqlClient", null, () => new DefaultSqlExecutionStrategy()));

    AddDependencyResolver(new SingletonDependencyResolver<Func<MigrationSqlGenerator>>(
        () => new SqlServerMigrationSqlGenerator(), "System.data.SqlClient"));

    AddDependencyResolver(new SingletonDependencyResolver<DbSpatialServices>(
        SqlSpatialServices.Instance,
        k =>
        {
            var asSpatialKey = k as DbProviderInfo;
            return asSpatialKey == null
                || asSpatialKey.ProviderInvariantName == ProviderInvariantName;
        }));
}
```

Этот конструктор использует следующие вспомогательные классы:

*   Синглетондепенденциресолвер: предоставляет простой способ разрешения одноэлементных служб, то есть служб, для которых один и тот же экземпляр возвращается при каждом вызове метода WebService. Временные службы часто регистрируются как одноэлементные фабрики, которые будут использоваться для создания временных экземпляров по запросу.
*   Ексекутионстратегиресолвер: сопоставитель, относящийся к возврату реализаций Иексекутионстратеги.

Вместо использования DbProviderServices. Адддепенденциресолвер можно также переопределить DbProviderServices.-Service и разрешить дополнительные службы напрямую. Этот метод будет вызываться, когда EF требуется служба, определенная определенным типом, и в некоторых случаях для данного ключа. Метод должен возвращать службу, если это возможно, или вернуть значение null, чтобы отказаться от возврата службы, а вместо этого разрешить другому классу разрешить его. Например, чтобы разрешить фабрику подключений по умолчанию, код в службе службы может выглядеть примерно так:

``` csharp
public override object GetService(Type type, object key)
{
    if (type == typeof(IDbConnectionFactory))
    {
        return new SqlConnectionFactory();
    }
    return null;
}
```

### <a name="registration-order"></a>Порядок регистрации

Если в файле конфигурации приложения зарегистрировано несколько реализаций DbProviderServices, они будут добавлены в качестве дополнительных арбитров конфликтов в том порядке, в котором они перечислены. Так как арбитры конфликтов всегда добавляются в верхнюю часть цепочки сопоставителя, это означает, что поставщик в конце списка получит шанс разрешать зависимости перед другими. (Это может показаться немного интуитивно понятным со счетчиком, но имеет смысл, если вы представиме, что каждый поставщик помещается из списка и помещаете его поверх существующих поставщиков.)

Такое упорядочение обычно не имеет значения, так как большинство служб поставщика относятся к конкретному поставщику и имеют ключ в инвариантном имени поставщика. Однако для служб, которые не являются ключевыми для инвариантного имени поставщика или какого-либо другого специфического для поставщика ключа, служба будет разрешена на основе этого упорядочения. Например, если он не задан явно в другом месте, фабрика соединений по умолчанию будет поступать от самого верхнего поставщика в цепочке.

## <a name="additional-config-file-registrations"></a>Дополнительные регистрации файлов конфигурации

Можно явно зарегистрировать некоторые дополнительные службы поставщика, описанные выше, непосредственно в файле конфигурации приложения. При этом регистрация в файле конфигурации будет использоваться вместо любых данных, возвращаемых методом DbProviderServices реализации.

### <a name="registering-the-default-connection-factory"></a>Регистрация фабрики подключений по умолчанию

Начиная с EF5 пакет NuGet EntityFramework автоматически зарегистрировал фабрику подключений SQL Express или фабрику подключений LocalDb в файле конфигурации.

Пример:

``` xml
<entityFramework>
  <defaultConnectionFactory type="System.Data.Entity.Infrastructure.SqlConnectionFactory, EntityFramework" >
</entityFramework>
```

_Тип_ — это имя типа с указанием сборки для фабрики соединений по умолчанию, которая должна реализовывать идбконнектионфактори.

Рекомендуется, чтобы пакет NuGet поставщика устанавливал фабрику соединений по умолчанию таким образом, как если бы она была установлена. Ниже приведены _пакеты NuGet для поставщиков_ .

## <a name="additional-ef6-provider-changes"></a>Дополнительные изменения поставщика EF6

### <a name="spatial-provider-changes"></a>Изменения пространственных поставщиков

Поставщики, поддерживающие пространственные типы, теперь должны реализовывать некоторые дополнительные методы для классов, производных от Дбспатиалдатареадер:

*   `public abstract bool IsGeographyColumn(int ordinal)`
*   `public abstract bool IsGeometryColumn(int ordinal)`

Существуют также новые асинхронные версии существующих методов, которые рекомендуется переопределять в качестве реализаций по умолчанию для синхронных методов и поэтому не выполняются асинхронно:

*   `public virtual Task<DbGeography> GetGeographyAsync(int ordinal, CancellationToken cancellationToken)`
*   `public virtual Task<DbGeometry> GetGeometryAsync(int ordinal, CancellationToken cancellationToken)`

### <a name="native-support-for-enumerablecontains"></a>Собственная поддержка для Enumerable. Contains

EF6 вводит новый тип выражения Дбинекспрессион, который был добавлен для устранения проблем с производительностью, связанных с использованием Enumerable. содержит в запросах LINQ. Класс DbProviderManifest содержит новый виртуальный метод Суппортсинекспрессион, который вызывается EF для определения того, обрабатывает ли поставщик новый тип выражения. Для совместимости с существующими реализациями поставщиков метод возвращает значение false. Чтобы воспользоваться этим улучшением, поставщик EF6 может добавить код для управления Дбинекспрессион и переопределить Суппортсинекспрессион, чтобы возвращалось значение true. Экземпляр Дбинекспрессион можно создать, вызвав метод DbExpressionBuilder.In. Экземпляр Дбинекспрессион состоит из DbExpression, обычно представляющего столбец таблицы, и списка DbConstantExpression для проверки соответствия.

## <a name="nuget-packages-for-providers"></a>Пакеты NuGet для поставщиков

Один из способов сделать доступным поставщик EF6 — освободить его как пакет NuGet. Использование пакета NuGet имеет следующие преимущества.

*   Вы можете легко использовать NuGet для добавления регистрации поставщика в файл конфигурации приложения.
*   В файл конфигурации можно внести дополнительные изменения, чтобы задать фабрику подключений по умолчанию, чтобы подключения, выполняемые по соглашению, использовали зарегистрированный поставщик.
*   NuGet обрабатывает Добавление перенаправлений привязок, чтобы поставщик EF6 продолжал работать даже после выпуска нового пакета EF.

Примером этого является пакет EntityFramework. Склсерверкомпакт, включенный в [базу кода с открытым исходным кодом](https://github.com/aspnet/entityframework6). Этот пакет предоставляет хороший шаблон для создания пакетов NuGet поставщика EF.

### <a name="powershell-commands"></a>Команды PowerShell

После установки пакета NuGet EntityFramework регистрируется модуль PowerShell, содержащий две команды, которые очень полезны для пакетов поставщиков:

*   Add-Ефпровидер добавляет новую сущность для поставщика в файл конфигурации целевого проекта и проверяет его в конце списка зарегистрированных поставщиков.
*   Add-Ефдефаултконнектионфактори либо добавляет, либо обновляет регистрацию Дефаултконнектионфактори в файле конфигурации целевого проекта.

Обе эти команды потребуют добавления раздела entityFramework в файл конфигурации и добавления коллекции поставщиков при необходимости.

Предполагается, что эти команды вызываются из скрипта install.ps1 NuGet. Например, install.ps1 для поставщика SQL Compact выглядит примерно так:

``` powershell
param($installPath, $toolsPath, $package, $project)
Add-EFDefaultConnectionFactory $project 'System.Data.Entity.Infrastructure.SqlCeConnectionFactory, EntityFramework' -ConstructorArguments 'System.Data.SqlServerCe.4.0'
Add-EFProvider $project 'System.Data.SqlServerCe.4.0' 'System.Data.Entity.SqlServerCompact.SqlCeProviderServices, EntityFramework.SqlServerCompact'</pre>
```

Дополнительные сведения об этих командах можно получить с помощью команды Get-Help в окне консоли диспетчера пакетов.

## <a name="wrapping-providers"></a>Создание оболочек для поставщиков

Поставщик упаковки — это поставщик EF или ADO.NET, который создает оболочку для существующего поставщика и расширяет его с помощью других функциональных возможностей, таких как возможности профилирования или трассировки. Поставщики замедления могут быть зарегистрированы обычным способом, но часто бывает удобнее настроить поставщик оболочки во время выполнения путем перехвата разрешения служб, связанных с поставщиком. Для этого можно использовать статическое событие Онлоккингконфигуратион в классе DbConfiguration.

Онлоккингконфигуратион вызывается после того, как EF определит, куда будет получена вся конфигурация EF для домена приложения, но до того, как он был заблокирован для использования. При запуске приложения (перед использованием EF) приложение должно зарегистрировать обработчик событий для этого события. (Мы рекомендуем добавить поддержку регистрации этого обработчика в файле конфигурации, но это еще не поддерживается.) После этого обработчик событий должен вызвать Реплацесервице для каждой службы, которая должна быть заключена в оболочку.  

Например, чтобы заключить в оболочку Идбконнектионфактори и Дбпровидерсервице, необходимо зарегистрировать обработчик примерно следующего вида:

``` csharp
DbConfiguration.OnLockingConfiguration +=
    (_, a) =>
    {
        a.ReplaceService<DbProviderServices>(
            (s, k) => new MyWrappedProviderServices(s));

        a.ReplaceService<IDbConnectionFactory>(
            (s, k) => new MyWrappedConnectionFactory(s));
    };
```

Служба, которая была разрешена и теперь должна быть упакована вместе с ключом, который использовался для разрешения этой службы, передается в обработчик. Затем обработчик может заключить эту службу в оболочку и заменить возвращенную службу на упакованную версию.

## <a name="resolving-a-dbproviderfactory-with-ef"></a>Разрешение DbProviderFactory с помощью EF

DbProviderFactory является одним из основных типов поставщиков, необходимых для EF, как описано в разделе _Обзор типов поставщиков_ выше. Как уже упоминалось, это не тип EF и регистрация, как правило, не являются частью конфигурации EF, но вместо обычной регистрации поставщика ADO.NET в файле machine.config и/или файле конфигурации приложения.

Несмотря на то, что этот EF по-прежнему использует стандартный механизм разрешения зависимостей при поиске DbProviderFactory для использования. Сопоставитель по умолчанию использует обычную регистрацию ADO.NET в файлах конфигурации, поэтому обычно это прозрачно. Однако из-за использования обычного механизма разрешения зависимостей это означает, что Идбдепенденциресолвер можно использовать для разрешения DbProviderFactory, даже если нормальная регистрация ADO.NET не выполнена.

Разрешение DbProviderFactory таким образом имеет несколько последствий:

*   Приложение, использующее конфигурацию на основе кода, может добавлять вызовы в свой класс DbConfiguration для регистрации соответствующего DbProviderFactory. Это особенно полезно для приложений, которые не хотят (или не могут) использовать файловую конфигурацию вообще.
*   Службу можно обернуть или заменить с помощью Реплацесервице, как описано в разделе о _поставщиках упаковки_ выше.
*   Теоретически, реализация DbProviderServices может разрешить DbProviderFactory.

Важно отметить, что при выполнении любого из этих действий они будут влиять только на поиск DbProviderFactory по EF. Другой код, не связанный с EF, может по-прежнему рассчитывать на то, что поставщик ADO.NET будет зарегистрирован обычным образом и может завершиться ошибкой, если регистрация не найдена. По этой причине лучше DbProviderFactory регистрацию в обычном ADO.NET.

### <a name="related-services"></a>Связанные службы

Если EF используется для разрешения DbProviderFactory, он также должен разрешить службы Ипровидеринвариантнаме и Идбпровидерфакториресолвер.

Ипровидеринвариантнаме — это служба, которая используется для определения инвариантного имени поставщика для данного типа DbProviderFactory. Реализация по умолчанию этой службы использует регистрацию поставщика ADO.NET. Это означает, что если поставщик ADO.NET не зарегистрирован обычным образом, поскольку DbProviderFactory разрешается EF, то он также потребуется для разрешения этой службы. Обратите внимание, что сопоставитель для этой службы автоматически добавляется при использовании метода DbConfiguration. Сетпровидерфактори.

Как описано в разделе _Общие сведения о типах поставщиков_ , идбпровидерфакториресолвер используется для получения правильного DbProviderFactory из данного объекта DbConnection. Реализация по умолчанию для этой службы при работе в .NET 4 использует регистрацию поставщика ADO.NET. Это означает, что если поставщик ADO.NET не зарегистрирован обычным образом, поскольку DbProviderFactory разрешается EF, то он также потребуется для разрешения этой службы.
