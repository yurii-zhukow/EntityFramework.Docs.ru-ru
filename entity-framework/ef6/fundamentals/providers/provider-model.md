---
title: Модель поставщика Entity Framework 6 — EF6
description: Модель поставщика Entity Framework 6 в Entity Framework 6
author: ajcvickers
ms.date: 06/27/2018
uid: ef6/fundamentals/providers/provider-model
ms.openlocfilehash: 15b5443ff05b5c8704f80d4f2f83b4ed20edd1c0
ms.sourcegitcommit: 0a25c03fa65ae6e0e0e3f66bac48d59eceb96a5a
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/14/2020
ms.locfileid: "92063196"
---
# <a name="the-entity-framework-6-provider-model"></a><span data-ttu-id="2af40-103">Модель поставщика Entity Framework 6</span><span class="sxs-lookup"><span data-stu-id="2af40-103">The Entity Framework 6 provider model</span></span>

<span data-ttu-id="2af40-104">Модель поставщика Entity Framework позволяет использовать Entity Framework с различными типами серверов баз данных.</span><span class="sxs-lookup"><span data-stu-id="2af40-104">The Entity Framework provider model allows Entity Framework to be used with different types of database server.</span></span> <span data-ttu-id="2af40-105">Например, один поставщик можно подключить, чтобы разрешить использование EF для Microsoft SQL Server, а другой поставщик можно подключить, чтобы разрешить использование EF для Microsoft SQL Server Compact Edition.</span><span class="sxs-lookup"><span data-stu-id="2af40-105">For example, one provider can be plugged in to allow EF to be used against Microsoft SQL Server, while another provider can be plugged into to allow EF to be used against Microsoft SQL Server Compact Edition.</span></span> <span data-ttu-id="2af40-106">Поставщики EF6, о которых мы осведомлены, можно найти на странице [поставщиков Entity Framework](xref:ef6/fundamentals/providers/index) .</span><span class="sxs-lookup"><span data-stu-id="2af40-106">The providers for EF6 that we are aware of can be found on the [Entity Framework providers](xref:ef6/fundamentals/providers/index) page.</span></span>

<span data-ttu-id="2af40-107">Для того, чтобы EF взаимодействовал с поставщиками, были необходимы некоторые изменения, чтобы платформа EF была выпущена в рамках лицензии с открытым исходным кодом.</span><span class="sxs-lookup"><span data-stu-id="2af40-107">Certain changes were required to the way EF interacts with providers to allow EF to be released under an open source license.</span></span> <span data-ttu-id="2af40-108">Эти изменения потребует перестроения поставщиков EF для сборок EF6 вместе с новыми механизмами регистрации поставщика.</span><span class="sxs-lookup"><span data-stu-id="2af40-108">These changes require rebuilding of EF providers against the EF6 assemblies together with new mechanisms for registration of the provider.</span></span>

## <a name="rebuilding"></a><span data-ttu-id="2af40-109">Перестроение</span><span class="sxs-lookup"><span data-stu-id="2af40-109">Rebuilding</span></span>

<span data-ttu-id="2af40-110">При использовании EF6 основной код, который ранее был частью .NET Framework, теперь поставляется как сборки с нестандартным доступом (OOB).</span><span class="sxs-lookup"><span data-stu-id="2af40-110">With EF6 the core code that was previously part of the .NET Framework is now being shipped as out-of-band (OOB) assemblies.</span></span> <span data-ttu-id="2af40-111">Сведения о том, как создавать приложения для EF6, можно найти на странице [Обновление приложений для EF6](xref:ef6/what-is-new/upgrading-to-ef6) .</span><span class="sxs-lookup"><span data-stu-id="2af40-111">Details on how to build applications against EF6 can be found on the [Updating applications for EF6](xref:ef6/what-is-new/upgrading-to-ef6) page.</span></span> <span data-ttu-id="2af40-112">Поставщики также потребуется перестраивать, используя эти инструкции.</span><span class="sxs-lookup"><span data-stu-id="2af40-112">Providers will also need to be rebuilt using these instructions.</span></span>

## <a name="provider-types-overview"></a><span data-ttu-id="2af40-113">Общие сведения о типах поставщиков</span><span class="sxs-lookup"><span data-stu-id="2af40-113">Provider types overview</span></span>

<span data-ttu-id="2af40-114">Поставщик EF представляет собой коллекцию служб, зависящих от поставщика, определенных типами CLR, от которых эти службы расширяются (для базового класса) или реализуют (для интерфейса).</span><span class="sxs-lookup"><span data-stu-id="2af40-114">An EF provider is really a collection of provider-specific services defined by CLR types that these services extend from (for a base class) or implement (for an interface).</span></span> <span data-ttu-id="2af40-115">Две из этих служб являются фундаментальными и необходимы для правильной работы EF.</span><span class="sxs-lookup"><span data-stu-id="2af40-115">Two of these services are fundamental and necessary for EF to function at all.</span></span> <span data-ttu-id="2af40-116">Другие являются необязательными и должны быть реализованы только в том случае, если требуются определенные функциональные возможности и/или реализации по умолчанию для этих служб не работают для целевого сервера базы данных.</span><span class="sxs-lookup"><span data-stu-id="2af40-116">Others are optional and only need to be implemented if specific functionality is required and/or the default implementations of these services does not work for the specific database server being targeted.</span></span>

## <a name="fundamental-provider-types"></a><span data-ttu-id="2af40-117">Основные типы поставщиков</span><span class="sxs-lookup"><span data-stu-id="2af40-117">Fundamental provider types</span></span>

### <a name="dbproviderfactory"></a><span data-ttu-id="2af40-118">DbProviderFactory</span><span class="sxs-lookup"><span data-stu-id="2af40-118">DbProviderFactory</span></span>

<span data-ttu-id="2af40-119">EF зависит от наличия типа, производного от [System. Data. Common. DbProviderFactory](https://msdn.microsoft.com/library/system.data.common.dbproviderfactory.aspx) , для выполнения всех низкоуровневых операций доступа к базе данных.</span><span class="sxs-lookup"><span data-stu-id="2af40-119">EF depends on having a type derived from [System.Data.Common.DbProviderFactory](https://msdn.microsoft.com/library/system.data.common.dbproviderfactory.aspx) for performing all low-level database access.</span></span> <span data-ttu-id="2af40-120">DbProviderFactory на самом деле не является частью EF, но является классом в .NET Framework, который обслуживает точку входа для поставщиков ADO.NET, которые могут использоваться EF, другими O/RMs или напрямую приложением для получения экземпляров соединений, команд, параметров и других абстракций ADO.NET в независимом от поставщика виде.</span><span class="sxs-lookup"><span data-stu-id="2af40-120">DbProviderFactory is not actually part of EF but is instead a class in the .NET Framework that serves an entry point for ADO.NET providers that can be used by EF, other O/RMs or directly by an application to obtain instances of connections, commands, parameters and other ADO.NET abstractions in a provider agnostic way.</span></span> <span data-ttu-id="2af40-121">Дополнительные сведения о DbProviderFactory можно найти в [документации MSDN по ADO.NET](https://msdn.microsoft.com/library/a6cd7c08.aspx).</span><span class="sxs-lookup"><span data-stu-id="2af40-121">More information about DbProviderFactory can be found in the [MSDN documentation for ADO.NET](https://msdn.microsoft.com/library/a6cd7c08.aspx).</span></span>

### <a name="dbproviderservices"></a><span data-ttu-id="2af40-122">DbProviderServices</span><span class="sxs-lookup"><span data-stu-id="2af40-122">DbProviderServices</span></span>

<span data-ttu-id="2af40-123">EF зависит от наличия типа, производного от DbProviderServices, для предоставления дополнительных функциональных возможностей, необходимых EF поверх функциональности, уже предоставленной поставщиком ADO.NET.</span><span class="sxs-lookup"><span data-stu-id="2af40-123">EF depends on having a type derived from DbProviderServices for providing additional functionality needed by EF on top of the functionality already provided by the ADO.NET provider.</span></span> <span data-ttu-id="2af40-124">В более ранних версиях EF класс DbProviderServices был частью .NET Framework и обнаружен в пространстве имен System. Data. Common.</span><span class="sxs-lookup"><span data-stu-id="2af40-124">In older versions of EF the DbProviderServices class was part of the .NET Framework and was found in the System.Data.Common namespace.</span></span> <span data-ttu-id="2af40-125">Начиная с EF6 этот класс теперь является частью EntityFramework.dll и находится в пространстве имен System. Data. Entity. Core. Common.</span><span class="sxs-lookup"><span data-stu-id="2af40-125">Starting with EF6 this class is now part of EntityFramework.dll and is in the System.Data.Entity.Core.Common namespace.</span></span>

<span data-ttu-id="2af40-126">Дополнительные сведения об основных функциях реализации DbProviderServices можно найти на [сайте MSDN](https://msdn.microsoft.com/library/ee789835.aspx).</span><span class="sxs-lookup"><span data-stu-id="2af40-126">More details about the fundamental functionality of a DbProviderServices implementation can be found on [MSDN](https://msdn.microsoft.com/library/ee789835.aspx).</span></span> <span data-ttu-id="2af40-127">Однако обратите внимание, что во время написания этих сведений не обновляется для EF6, хотя большая часть концепций все еще действительна.</span><span class="sxs-lookup"><span data-stu-id="2af40-127">However, note that as of the time of writing this information is not updated for EF6 although most of the concepts are still valid.</span></span> <span data-ttu-id="2af40-128">Реализации SQL Server и SQL Server Compact DbProviderServices также возвращаются в [базу кода с открытым исходным кодом](https://github.com/aspnet/EntityFramework6/) и могут служить полезными ссылками для других реализаций.</span><span class="sxs-lookup"><span data-stu-id="2af40-128">The SQL Server and SQL Server Compact implementations of DbProviderServices are also checked into to the [open-source codebase](https://github.com/aspnet/EntityFramework6/) and can serve as useful references for other implementations.</span></span>

<span data-ttu-id="2af40-129">В более ранних версиях EF используемая реализация DbProviderServices была получена непосредственно от поставщика ADO.NET.</span><span class="sxs-lookup"><span data-stu-id="2af40-129">In older versions of EF the DbProviderServices implementation to use was obtained directly from an ADO.NET provider.</span></span> <span data-ttu-id="2af40-130">Это было сделано путем приведения DbProviderFactory к IServiceProvider и вызова метода «услуга».</span><span class="sxs-lookup"><span data-stu-id="2af40-130">This was done by casting DbProviderFactory to IServiceProvider and calling the GetService method.</span></span> <span data-ttu-id="2af40-131">Это тесно связывает поставщик EF с DbProviderFactory.</span><span class="sxs-lookup"><span data-stu-id="2af40-131">This tightly coupled the EF provider to the DbProviderFactory.</span></span> <span data-ttu-id="2af40-132">Эта связь блокирует связь EF от .NET Framework и, следовательно, для EF6 была удалена эта тесная связь, и реализация DbProviderServices теперь зарегистрирована непосредственно в файле конфигурации приложения или в конфигурации на основе кода, как описано в разделе _Регистрация DbProviderServices_ ниже.</span><span class="sxs-lookup"><span data-stu-id="2af40-132">This coupling blocked EF from being moved out of the .NET Framework and therefore for EF6 this tight coupling has been removed and an implementation of DbProviderServices is now registered directly in the application’s configuration file or in code-based configuration as described in more detail the _Registering DbProviderServices_ section below.</span></span>

## <a name="additional-services"></a><span data-ttu-id="2af40-133">Дополнительные службы</span><span class="sxs-lookup"><span data-stu-id="2af40-133">Additional services</span></span>

<span data-ttu-id="2af40-134">Помимо основных служб, описанных выше, также существует множество других служб, используемых EF, которые либо всегда, либо иногда относятся к конкретному поставщику.</span><span class="sxs-lookup"><span data-stu-id="2af40-134">In addition to the fundamental services described above there are also many other services used by EF which are either always or sometimes provider-specific.</span></span> <span data-ttu-id="2af40-135">Реализации по умолчанию для этих служб, зависящие от поставщика, могут предоставляться реализацией DbProviderServices.</span><span class="sxs-lookup"><span data-stu-id="2af40-135">Default provider-specific implementations of these services can be supplied by a DbProviderServices implementation.</span></span> <span data-ttu-id="2af40-136">Приложения также могут переопределять реализации этих служб или предоставлять реализации, если тип DbProviderServices не предоставляет значение по умолчанию.</span><span class="sxs-lookup"><span data-stu-id="2af40-136">Applications can also override the implementations of these services, or provide implementations when a DbProviderServices type does not provide a default.</span></span> <span data-ttu-id="2af40-137">Это подробно описано в разделе _разрешение дополнительных служб_ ниже.</span><span class="sxs-lookup"><span data-stu-id="2af40-137">This is described in more detail in the _Resolving additional services_ section below.</span></span>

<span data-ttu-id="2af40-138">Ниже перечислены дополнительные типы служб, которые поставщик может представлять интерес для поставщика.</span><span class="sxs-lookup"><span data-stu-id="2af40-138">The additional service types that a provider may be of interest to a provider are listed below.</span></span> <span data-ttu-id="2af40-139">Дополнительные сведения о каждом из этих типов служб можно найти в документации по API.</span><span class="sxs-lookup"><span data-stu-id="2af40-139">More details about each of these service types can be found in the API documentation.</span></span>

### <a name="idbexecutionstrategy"></a><span data-ttu-id="2af40-140">IDbExecutionStrategy</span><span class="sxs-lookup"><span data-stu-id="2af40-140">IDbExecutionStrategy</span></span>

<span data-ttu-id="2af40-141">Это необязательная служба, позволяющая поставщику реализовать повторные попытки или другое поведение при выполнении запросов и команд в базе данных.</span><span class="sxs-lookup"><span data-stu-id="2af40-141">This is an optional service that allows a provider to implement retries or other behavior when queries and commands are executed against the database.</span></span> <span data-ttu-id="2af40-142">Если реализация не предоставлена, EF будет просто выполнять команды и распространять все возникшие исключения.</span><span class="sxs-lookup"><span data-stu-id="2af40-142">If no implementation is provided, then EF will simply execute the commands and propagate any exceptions thrown.</span></span> <span data-ttu-id="2af40-143">Для SQL Server эта служба используется для предоставления политики повтора, которая особенно полезна при запуске на облачных серверах баз данных, таких как SQL Azure.</span><span class="sxs-lookup"><span data-stu-id="2af40-143">For SQL Server this service is used to provide a retry policy which is especially useful when running against cloud-based database servers such as SQL Azure.</span></span>

### <a name="idbconnectionfactory"></a><span data-ttu-id="2af40-144">идбконнектионфактори</span><span class="sxs-lookup"><span data-stu-id="2af40-144">IDbConnectionFactory</span></span>

<span data-ttu-id="2af40-145">Это необязательная служба, позволяющая поставщику создавать объекты DbConnection по соглашению, если задано только имя базы данных.</span><span class="sxs-lookup"><span data-stu-id="2af40-145">This is an optional service that allows a provider to create DbConnection objects by convention when given only a database name.</span></span> <span data-ttu-id="2af40-146">Обратите внимание, что хотя эта служба может быть разрешена реализацией DbProviderServices, которая имеется в EF 4,1 и может быть явно задана в файле конфигурации или в коде.</span><span class="sxs-lookup"><span data-stu-id="2af40-146">Note that while this service can be resolved by a DbProviderServices implementation it has been present since EF 4.1 and can also be explicitly set in either the config file or in code.</span></span> <span data-ttu-id="2af40-147">Поставщик может получить возможность разрешить эту службу, только если она зарегистрирована как поставщик по умолчанию (см. _поставщик по умолчанию_ ниже) и если фабрика соединений по умолчанию не задана в других местах.</span><span class="sxs-lookup"><span data-stu-id="2af40-147">The provider will only get a chance to resolve this service if it registered as the default provider (see _The default provider_ below) and if a default connection factory has not been set elsewhere.</span></span>

### <a name="dbspatialservices"></a><span data-ttu-id="2af40-148">дбспатиалсервицес</span><span class="sxs-lookup"><span data-stu-id="2af40-148">DbSpatialServices</span></span>

<span data-ttu-id="2af40-149">Это необязательные службы, позволяющие поставщику добавить поддержку пространственных и геометрических типов географических объектов.</span><span class="sxs-lookup"><span data-stu-id="2af40-149">This is an optional services that allows a provider to add support for geography and geometry spatial types.</span></span> <span data-ttu-id="2af40-150">Чтобы приложение использовало EF с пространственными типами, необходимо предоставить реализацию этой службы.</span><span class="sxs-lookup"><span data-stu-id="2af40-150">An implementation of this service must be supplied in order for an application to use EF with spatial types.</span></span> <span data-ttu-id="2af40-151">Дбсптиалсервицес запрашивается двумя способами.</span><span class="sxs-lookup"><span data-stu-id="2af40-151">DbSptialServices is asked for in two ways.</span></span> <span data-ttu-id="2af40-152">Во-первых, пространственные службы, зависящие от поставщика, запрашиваются с помощью объекта Дбпровидеринфо (который содержит инвариантное имя и токен манифеста) в качестве ключа.</span><span class="sxs-lookup"><span data-stu-id="2af40-152">First, provider-specific spatial services are requested using a DbProviderInfo object (which contains invariant name and manifest token) as key.</span></span> <span data-ttu-id="2af40-153">Во вторых, Дбспатиалсервицес может запрашиваться без ключа.</span><span class="sxs-lookup"><span data-stu-id="2af40-153">Second, DbSpatialServices can be asked for with no key.</span></span> <span data-ttu-id="2af40-154">Используется для разрешения "глобального пространственного поставщика", который используется при создании изолированных типов заданное DbGeography или заданное DbGeometry.</span><span class="sxs-lookup"><span data-stu-id="2af40-154">This is used to resolve the “global spatial provider” that is used when creating stand-alone DbGeography or DbGeometry types.</span></span>

### <a name="migrationsqlgenerator"></a><span data-ttu-id="2af40-155">мигратионсклженератор</span><span class="sxs-lookup"><span data-stu-id="2af40-155">MigrationSqlGenerator</span></span>

<span data-ttu-id="2af40-156">Это необязательная служба, позволяющая использовать миграции EF для создания SQL-кода, используемого при создании и изменении схем базы данных, Code First.</span><span class="sxs-lookup"><span data-stu-id="2af40-156">This is an optional service that allows EF Migrations to be used for the generation of SQL used in creating and modifying database schemas by Code First.</span></span> <span data-ttu-id="2af40-157">Для поддержки миграции требуется реализация.</span><span class="sxs-lookup"><span data-stu-id="2af40-157">An implementation is required in order to support Migrations.</span></span> <span data-ttu-id="2af40-158">Если реализация предоставлена, она также будет использоваться при создании баз данных с помощью инициализаторов баз данных или метода Database. Create.</span><span class="sxs-lookup"><span data-stu-id="2af40-158">If an implementation is provided then it will also be used when databases are created using database initializers or the Database.Create method.</span></span>

### <a name="funcdbconnection-string-historycontextfactory"></a><span data-ttu-id="2af40-159">Func<DbConnection, String, Хисториконтекстфактори></span><span class="sxs-lookup"><span data-stu-id="2af40-159">Func<DbConnection, string, HistoryContextFactory></span></span>

<span data-ttu-id="2af40-160">Это необязательная служба, позволяющая поставщику настроить сопоставление Хисториконтекст с `__MigrationHistory` таблицей, используемой при миграции EF.</span><span class="sxs-lookup"><span data-stu-id="2af40-160">This is an optional service that allows a provider to configure the mapping of the HistoryContext to the `__MigrationHistory` table used by EF Migrations.</span></span> <span data-ttu-id="2af40-161">Хисториконтекст — это Code First DbContext. его можно настроить с помощью обычного API-интерфейса Fluent, чтобы изменить такие параметры, как имя таблицы и спецификации сопоставления столбцов.</span><span class="sxs-lookup"><span data-stu-id="2af40-161">The HistoryContext is a Code First DbContext and can be configured using the normal fluent API to change things like the name of the table and the column mapping specifications.</span></span> <span data-ttu-id="2af40-162">Реализация по умолчанию этой службы, возвращаемая EF для всех поставщиков, может работать для данного сервера базы данных, если все сопоставления таблиц и столбцов по умолчанию поддерживаются этим поставщиком.</span><span class="sxs-lookup"><span data-stu-id="2af40-162">The default implementation of this service returned by EF for all providers may work for a given database server if all the default table and column mappings are supported by that provider.</span></span> <span data-ttu-id="2af40-163">В этом случае поставщику не требуется предоставлять реализацию этой службы.</span><span class="sxs-lookup"><span data-stu-id="2af40-163">In such a case the provider does not need to supply an implementation of this service.</span></span>

### <a name="idbproviderfactoryresolver"></a><span data-ttu-id="2af40-164">идбпровидерфакториресолвер</span><span class="sxs-lookup"><span data-stu-id="2af40-164">IDbProviderFactoryResolver</span></span>

<span data-ttu-id="2af40-165">Это необязательная служба для получения правильного DbProviderFactory из данного объекта DbConnection.</span><span class="sxs-lookup"><span data-stu-id="2af40-165">This is an optional service for obtaining the correct DbProviderFactory from a given DbConnection object.</span></span> <span data-ttu-id="2af40-166">Реализация по умолчанию этой службы, возвращаемая EF для всех поставщиков, предназначена для работы со всеми поставщиками.</span><span class="sxs-lookup"><span data-stu-id="2af40-166">The default implementation of this service returned by EF for all providers is intended to work for all providers.</span></span> <span data-ttu-id="2af40-167">Однако при работе в .NET 4 DbProviderFactory не является общедоступным из одного, если его Дбконнектионс.</span><span class="sxs-lookup"><span data-stu-id="2af40-167">However, when running on .NET 4, the DbProviderFactory is not publicly accessible from one if its DbConnections.</span></span> <span data-ttu-id="2af40-168">Таким образом, EF использует некоторые эвристические методы для поиска найденных поставщиков в зарегистрированных поставщиках.</span><span class="sxs-lookup"><span data-stu-id="2af40-168">Therefore, EF uses some heuristics to search the registered providers to find a match.</span></span> <span data-ttu-id="2af40-169">Некоторые поставщики могут завершиться ошибкой, и в таких ситуациях поставщик должен предоставить новую реализацию.</span><span class="sxs-lookup"><span data-stu-id="2af40-169">It is possible that for some providers these heuristics will fail and in such situations the provider should supply a new implementation.</span></span>

## <a name="registering-dbproviderservices"></a><span data-ttu-id="2af40-170">Регистрация DbProviderServices</span><span class="sxs-lookup"><span data-stu-id="2af40-170">Registering DbProviderServices</span></span>

<span data-ttu-id="2af40-171">Используемая реализация DbProviderServices может быть зарегистрирована либо в файле конфигурации приложения (app.config или web.config), либо с помощью конфигурации на основе кода.</span><span class="sxs-lookup"><span data-stu-id="2af40-171">The DbProviderServices implementation to use can be registered either in the application’s configuration file (app.config or web.config) or using code-based configuration.</span></span> <span data-ttu-id="2af40-172">В любом случае при регистрации в качестве ключа используется "инвариантное имя поставщика".</span><span class="sxs-lookup"><span data-stu-id="2af40-172">In either case the registration uses the provider’s “invariant name” as a key.</span></span> <span data-ttu-id="2af40-173">Это позволяет регистрировать и использовать несколько поставщиков в одном приложении.</span><span class="sxs-lookup"><span data-stu-id="2af40-173">This allows multiple providers to be registered and used in a single application.</span></span> <span data-ttu-id="2af40-174">Инвариантное имя, используемое для регистраций EF, совпадает с инвариантным именем, используемым для регистрации поставщика ADO.NET и строк подключения.</span><span class="sxs-lookup"><span data-stu-id="2af40-174">The invariant name used for EF registrations is the same as the invariant name used for ADO.NET provider registration and connection strings.</span></span> <span data-ttu-id="2af40-175">Например, для SQL Server используется инвариантное имя System. Data. SqlClient.</span><span class="sxs-lookup"><span data-stu-id="2af40-175">For example, for SQL Server the invariant name “System.Data.SqlClient” is used.</span></span>

### <a name="config-file-registration"></a><span data-ttu-id="2af40-176">Регистрация в файле конфигурации</span><span class="sxs-lookup"><span data-stu-id="2af40-176">Config file registration</span></span>

<span data-ttu-id="2af40-177">Используемый тип DbProviderServices регистрируется в качестве элемента поставщика в списке поставщиков раздела entityFramework файла конфигурации приложения.</span><span class="sxs-lookup"><span data-stu-id="2af40-177">The DbProviderServices type to use is registered as a provider element in the providers list of the entityFramework section of the application’s config file.</span></span> <span data-ttu-id="2af40-178">Например.</span><span class="sxs-lookup"><span data-stu-id="2af40-178">For example:</span></span>

``` xml
<entityFramework>
  <providers>
    <provider invariantName="My.Invariant.Name" type="MyProvider.MyProviderServices, MyAssembly" />
  </providers>
</entityFramework>
```

<span data-ttu-id="2af40-179">Строка _типа_ должна представлять собой имя типа с указанием сборки для используемой реализации DbProviderServices.</span><span class="sxs-lookup"><span data-stu-id="2af40-179">The _type_ string must be the assembly-qualified type name of the DbProviderServices implementation to use.</span></span>

### <a name="code-based-registration"></a><span data-ttu-id="2af40-180">Регистрация на основе кода</span><span class="sxs-lookup"><span data-stu-id="2af40-180">Code-based registration</span></span>

<span data-ttu-id="2af40-181">Начиная с поставщиков EF6, можно также регистрироваться с помощью кода.</span><span class="sxs-lookup"><span data-stu-id="2af40-181">Starting with EF6 providers can also be registered using code.</span></span> <span data-ttu-id="2af40-182">Это позволяет использовать поставщик EF без каких бы то ни было изменений в файле конфигурации приложения.</span><span class="sxs-lookup"><span data-stu-id="2af40-182">This allows an EF provider to be used without any change to the application’s configuration file.</span></span> <span data-ttu-id="2af40-183">Чтобы использовать конфигурацию на основе кода, приложение должно создать класс DbConfiguration, как описано в [документации по настройке на основе кода](https://msdn.com/data/jj680699).</span><span class="sxs-lookup"><span data-stu-id="2af40-183">To use code-based configuration an application should create a DbConfiguration class as described in the [code-based configuration documentation](https://msdn.com/data/jj680699).</span></span> <span data-ttu-id="2af40-184">Чтобы зарегистрировать поставщик EF, конструктор класса DbConfiguration должен вызвать Сетпровидерсервицес.</span><span class="sxs-lookup"><span data-stu-id="2af40-184">The constructor of the DbConfiguration class should then call SetProviderServices to register the EF provider.</span></span> <span data-ttu-id="2af40-185">Например.</span><span class="sxs-lookup"><span data-stu-id="2af40-185">For example:</span></span>

``` csharp
public class MyConfiguration : DbConfiguration
{
    public MyConfiguration()
    {
        SetProviderServices("My.New.Provider", new MyProviderServices());
    }
}
```

## <a name="resolving-additional-services"></a><span data-ttu-id="2af40-186">Разрешение дополнительных служб</span><span class="sxs-lookup"><span data-stu-id="2af40-186">Resolving additional services</span></span>

<span data-ttu-id="2af40-187">Как упоминалось выше в разделе _Обзор типов поставщиков_ , класс DbProviderServices можно также использовать для разрешения дополнительных служб.</span><span class="sxs-lookup"><span data-stu-id="2af40-187">As mentioned above in the _Provider types overview_ section, a DbProviderServices class can also be used to resolve additional services.</span></span> <span data-ttu-id="2af40-188">Это возможно, поскольку DbProviderServices реализует Идбдепенденциресолвер, а каждый зарегистрированный тип DbProviderServices добавляется в качестве сопоставителя по умолчанию.</span><span class="sxs-lookup"><span data-stu-id="2af40-188">This is possible because DbProviderServices implements IDbDependencyResolver and each registered DbProviderServices type is added as a “default resolver”.</span></span> <span data-ttu-id="2af40-189">Механизм Идбдпенденциресолвер более подробно описан в разделе [разрешение зависимостей](xref:ef6/fundamentals/configuring/dependency-resolution).</span><span class="sxs-lookup"><span data-stu-id="2af40-189">The IDbDpendencyResolver mechanism is described in more detail in [Dependency Resolution](xref:ef6/fundamentals/configuring/dependency-resolution).</span></span> <span data-ttu-id="2af40-190">Однако нет необходимости понимать все основные понятия в этой спецификации для разрешения дополнительных служб в поставщике.</span><span class="sxs-lookup"><span data-stu-id="2af40-190">However, it is not necessary to understand all the concepts in this specification to resolve additional services in a provider.</span></span>

<span data-ttu-id="2af40-191">Наиболее распространенным способом разрешения дополнительных служб для поставщика является вызов DbProviderServices. Адддепенденциресолвер для каждой службы в конструкторе класса DbProviderServices.</span><span class="sxs-lookup"><span data-stu-id="2af40-191">The most common way for a provider to resolve additional services is to call DbProviderServices.AddDependencyResolver for each service in the constructor of the DbProviderServices class.</span></span> <span data-ttu-id="2af40-192">Например, Склпровидерсервицес (поставщик EF для SQL Server) имеет следующий код для инициализации:</span><span class="sxs-lookup"><span data-stu-id="2af40-192">For example, SqlProviderServices (the EF provider for SQL Server) has code similar to this for initialization:</span></span>

``` csharp
private SqlProviderServices()
{
    AddDependencyResolver(new SingletonDependencyResolver<IDbConnectionFactory>(
        new SqlConnectionFactory()));

    AddDependencyResolver(new ExecutionStrategyResolver<DefaultSqlExecutionStrategy>(
        "System.data.SqlClient", null, () => new DefaultSqlExecutionStrategy()));

    AddDependencyResolver(new SingletonDependencyResolver<Func<MigrationSqlGenerator>>(
        () => new SqlServerMigrationSqlGenerator(), "System.data.SqlClient"));

    AddDependencyResolver(new SingletonDependencyResolver<DbSpatialServices>(
        SqlSpatialServices.Instance,
        k =>
        {
            var asSpatialKey = k as DbProviderInfo;
            return asSpatialKey == null
                || asSpatialKey.ProviderInvariantName == ProviderInvariantName;
        }));
}
```

<span data-ttu-id="2af40-193">Этот конструктор использует следующие вспомогательные классы:</span><span class="sxs-lookup"><span data-stu-id="2af40-193">This constructor uses the following helper classes:</span></span>

*   <span data-ttu-id="2af40-194">Синглетондепенденциресолвер: предоставляет простой способ разрешения одноэлементных служб, то есть служб, для которых один и тот же экземпляр возвращается при каждом вызове метода WebService.</span><span class="sxs-lookup"><span data-stu-id="2af40-194">SingletonDependencyResolver: provides a simple way to resolve Singleton services—that is, services for which the same instance is returned each time that GetService is called.</span></span> <span data-ttu-id="2af40-195">Временные службы часто регистрируются как одноэлементные фабрики, которые будут использоваться для создания временных экземпляров по запросу.</span><span class="sxs-lookup"><span data-stu-id="2af40-195">Transient services are often registered as a singleton factory that will be used to create transient instances on demand.</span></span>
*   <span data-ttu-id="2af40-196">Ексекутионстратегиресолвер: сопоставитель, относящийся к возврату реализаций Иексекутионстратеги.</span><span class="sxs-lookup"><span data-stu-id="2af40-196">ExecutionStrategyResolver: a resolver specific to returning IExecutionStrategy implementations.</span></span>

<span data-ttu-id="2af40-197">Вместо использования DbProviderServices. Адддепенденциресолвер можно также переопределить DbProviderServices.-Service и разрешить дополнительные службы напрямую.</span><span class="sxs-lookup"><span data-stu-id="2af40-197">Instead of using DbProviderServices.AddDependencyResolver it is also possible to override DbProviderServices.GetService and resolve additional services directly.</span></span> <span data-ttu-id="2af40-198">Этот метод будет вызываться, когда EF требуется служба, определенная определенным типом, и в некоторых случаях для данного ключа.</span><span class="sxs-lookup"><span data-stu-id="2af40-198">This method will be called when EF needs a service defined by a certain type and, in some cases, for a given key.</span></span> <span data-ttu-id="2af40-199">Метод должен возвращать службу, если это возможно, или вернуть значение null, чтобы отказаться от возврата службы, а вместо этого разрешить другому классу разрешить его.</span><span class="sxs-lookup"><span data-stu-id="2af40-199">The method should return the service if it can, or return null to opt-out of returning the service and instead allow another class to resolve it.</span></span> <span data-ttu-id="2af40-200">Например, чтобы разрешить фабрику подключений по умолчанию, код в службе службы может выглядеть примерно так:</span><span class="sxs-lookup"><span data-stu-id="2af40-200">For example, to resolve the default connection factory the code in GetService might look something like this:</span></span>

``` csharp
public override object GetService(Type type, object key)
{
    if (type == typeof(IDbConnectionFactory))
    {
        return new SqlConnectionFactory();
    }
    return null;
}
```

### <a name="registration-order"></a><span data-ttu-id="2af40-201">Порядок регистрации</span><span class="sxs-lookup"><span data-stu-id="2af40-201">Registration order</span></span>

<span data-ttu-id="2af40-202">Если в файле конфигурации приложения зарегистрировано несколько реализаций DbProviderServices, они будут добавлены в качестве дополнительных арбитров конфликтов в том порядке, в котором они перечислены.</span><span class="sxs-lookup"><span data-stu-id="2af40-202">When multiple DbProviderServices implementations are registered in an application’s config file they will be added as secondary resolvers in the order that they are listed.</span></span> <span data-ttu-id="2af40-203">Так как арбитры конфликтов всегда добавляются в верхнюю часть цепочки сопоставителя, это означает, что поставщик в конце списка получит шанс разрешать зависимости перед другими.</span><span class="sxs-lookup"><span data-stu-id="2af40-203">Since resolvers are always added to the top of the secondary resolver chain this means that the provider at the end of the list will get a chance to resolve dependencies before the others.</span></span> <span data-ttu-id="2af40-204">(Это может показаться немного интуитивно понятным со счетчиком, но имеет смысл, если вы представиме, что каждый поставщик помещается из списка и помещаете его поверх существующих поставщиков.)</span><span class="sxs-lookup"><span data-stu-id="2af40-204">(This can seem a little counter-intuitive at first, but it makes sense if you imagine taking each provider out of the list and stacking it on top of the existing providers.)</span></span>

<span data-ttu-id="2af40-205">Такое упорядочение обычно не имеет значения, так как большинство служб поставщика относятся к конкретному поставщику и имеют ключ в инвариантном имени поставщика.</span><span class="sxs-lookup"><span data-stu-id="2af40-205">This ordering usually doesn’t matter because most provider services are provider-specific and keyed by provider invariant name.</span></span> <span data-ttu-id="2af40-206">Однако для служб, которые не являются ключевыми для инвариантного имени поставщика или какого-либо другого специфического для поставщика ключа, служба будет разрешена на основе этого упорядочения.</span><span class="sxs-lookup"><span data-stu-id="2af40-206">However, for services that are not keyed by provider invariant name or some other provider-specific key the service will be resolved based on this ordering.</span></span> <span data-ttu-id="2af40-207">Например, если он не задан явно в другом месте, фабрика соединений по умолчанию будет поступать от самого верхнего поставщика в цепочке.</span><span class="sxs-lookup"><span data-stu-id="2af40-207">For example, if it is not explicitly set differently somewhere else, then the default connection factory will come from the topmost provider in the chain.</span></span>

## <a name="additional-config-file-registrations"></a><span data-ttu-id="2af40-208">Дополнительные регистрации файлов конфигурации</span><span class="sxs-lookup"><span data-stu-id="2af40-208">Additional config file registrations</span></span>

<span data-ttu-id="2af40-209">Можно явно зарегистрировать некоторые дополнительные службы поставщика, описанные выше, непосредственно в файле конфигурации приложения.</span><span class="sxs-lookup"><span data-stu-id="2af40-209">It is possible to explicitly register some of the additional provider services described above directly in an application’s config file.</span></span> <span data-ttu-id="2af40-210">При этом регистрация в файле конфигурации будет использоваться вместо любых данных, возвращаемых методом DbProviderServices реализации.</span><span class="sxs-lookup"><span data-stu-id="2af40-210">When this is done the registration in the config file will be used instead of anything returned by the GetService method of the DbProviderServices implementation.</span></span>

### <a name="registering-the-default-connection-factory"></a><span data-ttu-id="2af40-211">Регистрация фабрики подключений по умолчанию</span><span class="sxs-lookup"><span data-stu-id="2af40-211">Registering the default connection factory</span></span>

<span data-ttu-id="2af40-212">Начиная с EF5 пакет NuGet EntityFramework автоматически зарегистрировал фабрику подключений SQL Express или фабрику подключений LocalDb в файле конфигурации.</span><span class="sxs-lookup"><span data-stu-id="2af40-212">Starting with EF5 the EntityFramework NuGet package automatically registered either the SQL Express connection factory or the LocalDb connection factory in the config file.</span></span>

<span data-ttu-id="2af40-213">Например.</span><span class="sxs-lookup"><span data-stu-id="2af40-213">For example:</span></span>

``` xml
<entityFramework>
  <defaultConnectionFactory type="System.Data.Entity.Infrastructure.SqlConnectionFactory, EntityFramework" >
</entityFramework>
```

<span data-ttu-id="2af40-214">_Тип_ — это имя типа с указанием сборки для фабрики соединений по умолчанию, которая должна реализовывать идбконнектионфактори.</span><span class="sxs-lookup"><span data-stu-id="2af40-214">The _type_ is the assembly-qualified type name for the default connection factory, which must implement IDbConnectionFactory.</span></span>

<span data-ttu-id="2af40-215">Рекомендуется, чтобы пакет NuGet поставщика устанавливал фабрику соединений по умолчанию таким образом, как если бы она была установлена.</span><span class="sxs-lookup"><span data-stu-id="2af40-215">It is recommended that a provider NuGet package set the default connection factory in this way when installed.</span></span> <span data-ttu-id="2af40-216">Ниже приведены _пакеты NuGet для поставщиков_ .</span><span class="sxs-lookup"><span data-stu-id="2af40-216">See _NuGet Packages for providers_ below.</span></span>

## <a name="additional-ef6-provider-changes"></a><span data-ttu-id="2af40-217">Дополнительные изменения поставщика EF6</span><span class="sxs-lookup"><span data-stu-id="2af40-217">Additional EF6 provider changes</span></span>

### <a name="spatial-provider-changes"></a><span data-ttu-id="2af40-218">Изменения пространственных поставщиков</span><span class="sxs-lookup"><span data-stu-id="2af40-218">Spatial provider changes</span></span>

<span data-ttu-id="2af40-219">Поставщики, поддерживающие пространственные типы, теперь должны реализовывать некоторые дополнительные методы для классов, производных от Дбспатиалдатареадер:</span><span class="sxs-lookup"><span data-stu-id="2af40-219">Providers that support spatial types must now implement some additional methods on classes deriving from DbSpatialDataReader:</span></span>

*   `public abstract bool IsGeographyColumn(int ordinal)`
*   `public abstract bool IsGeometryColumn(int ordinal)`

<span data-ttu-id="2af40-220">Существуют также новые асинхронные версии существующих методов, которые рекомендуется переопределять в качестве реализаций по умолчанию для синхронных методов и поэтому не выполняются асинхронно:</span><span class="sxs-lookup"><span data-stu-id="2af40-220">There are also new asynchronous versions of existing methods that are recommended to be overridden as the default implementations delegate to the synchronous methods and therefore do not execute asynchronously:</span></span>

*   `public virtual Task<DbGeography> GetGeographyAsync(int ordinal, CancellationToken cancellationToken)`
*   `public virtual Task<DbGeometry> GetGeometryAsync(int ordinal, CancellationToken cancellationToken)`

### <a name="native-support-for-enumerablecontains"></a><span data-ttu-id="2af40-221">Собственная поддержка для Enumerable. Contains</span><span class="sxs-lookup"><span data-stu-id="2af40-221">Native support for Enumerable.Contains</span></span>

<span data-ttu-id="2af40-222">EF6 вводит новый тип выражения Дбинекспрессион, который был добавлен для устранения проблем с производительностью, связанных с использованием Enumerable. содержит в запросах LINQ.</span><span class="sxs-lookup"><span data-stu-id="2af40-222">EF6 introduces a new expression type, DbInExpression, which was added to address performance issues around use of Enumerable.Contains in LINQ queries.</span></span> <span data-ttu-id="2af40-223">Класс DbProviderManifest содержит новый виртуальный метод Суппортсинекспрессион, который вызывается EF для определения того, обрабатывает ли поставщик новый тип выражения.</span><span class="sxs-lookup"><span data-stu-id="2af40-223">The DbProviderManifest class has a new virtual method, SupportsInExpression, which is called by EF to determine if a provider handles the new expression type.</span></span> <span data-ttu-id="2af40-224">Для совместимости с существующими реализациями поставщиков метод возвращает значение false.</span><span class="sxs-lookup"><span data-stu-id="2af40-224">For compatibility with existing provider implementations the method returns false.</span></span> <span data-ttu-id="2af40-225">Чтобы воспользоваться этим улучшением, поставщик EF6 может добавить код для управления Дбинекспрессион и переопределить Суппортсинекспрессион, чтобы возвращалось значение true.</span><span class="sxs-lookup"><span data-stu-id="2af40-225">To benefit from this improvement, an EF6 provider can add code to handle DbInExpression and override SupportsInExpression to return true.</span></span> <span data-ttu-id="2af40-226">Экземпляр Дбинекспрессион можно создать, вызвав метод DbExpressionBuilder.In.</span><span class="sxs-lookup"><span data-stu-id="2af40-226">An instance of DbInExpression can be created by calling the DbExpressionBuilder.In method.</span></span> <span data-ttu-id="2af40-227">Экземпляр Дбинекспрессион состоит из DbExpression, обычно представляющего столбец таблицы, и списка DbConstantExpression для проверки соответствия.</span><span class="sxs-lookup"><span data-stu-id="2af40-227">A DbInExpression instance is composed of a DbExpression, usually representing a table column, and a list of DbConstantExpression to test for a match.</span></span>

## <a name="nuget-packages-for-providers"></a><span data-ttu-id="2af40-228">Пакеты NuGet для поставщиков</span><span class="sxs-lookup"><span data-stu-id="2af40-228">NuGet packages for providers</span></span>

<span data-ttu-id="2af40-229">Один из способов сделать доступным поставщик EF6 — освободить его как пакет NuGet.</span><span class="sxs-lookup"><span data-stu-id="2af40-229">One way to make an EF6 provider available is to release it as a NuGet package.</span></span> <span data-ttu-id="2af40-230">Использование пакета NuGet имеет следующие преимущества.</span><span class="sxs-lookup"><span data-stu-id="2af40-230">Using a NuGet package has the following advantages:</span></span>

*   <span data-ttu-id="2af40-231">Вы можете легко использовать NuGet для добавления регистрации поставщика в файл конфигурации приложения.</span><span class="sxs-lookup"><span data-stu-id="2af40-231">It is easy to use NuGet to add the provider registration to the application’s config file</span></span>
*   <span data-ttu-id="2af40-232">В файл конфигурации можно внести дополнительные изменения, чтобы задать фабрику подключений по умолчанию, чтобы подключения, выполняемые по соглашению, использовали зарегистрированный поставщик.</span><span class="sxs-lookup"><span data-stu-id="2af40-232">Additional changes can be made to the config file to set the default connection factory so that connections made by convention will use the registered provider</span></span>
*   <span data-ttu-id="2af40-233">NuGet обрабатывает Добавление перенаправлений привязок, чтобы поставщик EF6 продолжал работать даже после выпуска нового пакета EF.</span><span class="sxs-lookup"><span data-stu-id="2af40-233">NuGet handles adding binding redirects so that the EF6 provider should continue to work even after a new EF package is released</span></span>

<span data-ttu-id="2af40-234">Примером этого является пакет EntityFramework. Склсерверкомпакт, включенный в [базу кода с открытым исходным кодом](https://github.com/aspnet/entityframework6).</span><span class="sxs-lookup"><span data-stu-id="2af40-234">An example of this is the EntityFramework.SqlServerCompact package which is included in the [open source codebase](https://github.com/aspnet/entityframework6).</span></span> <span data-ttu-id="2af40-235">Этот пакет предоставляет хороший шаблон для создания пакетов NuGet поставщика EF.</span><span class="sxs-lookup"><span data-stu-id="2af40-235">This package provides a good template for creating EF provider NuGet packages.</span></span>

### <a name="powershell-commands"></a><span data-ttu-id="2af40-236">Команды PowerShell</span><span class="sxs-lookup"><span data-stu-id="2af40-236">PowerShell commands</span></span>

<span data-ttu-id="2af40-237">После установки пакета NuGet EntityFramework регистрируется модуль PowerShell, содержащий две команды, которые очень полезны для пакетов поставщиков:</span><span class="sxs-lookup"><span data-stu-id="2af40-237">When the EntityFramework NuGet package is installed it registers a PowerShell module that contains two commands that are very useful for provider packages:</span></span>

*   <span data-ttu-id="2af40-238">Add-EFProvider добавляет новую сущность для поставщика в файл конфигурации целевого проекта и проверяет, находится ли он в конце списка зарегистрированных поставщиков.</span><span class="sxs-lookup"><span data-stu-id="2af40-238">Add-EFProvider adds a new entity for the provider in the target project’s configuration file and makes sure it is at the end of the list of registered providers.</span></span>
*   <span data-ttu-id="2af40-239">Add-EFDefaultConnectionFactory либо добавляет, либо обновляет регистрацию Дефаултконнектионфактори в файле конфигурации целевого проекта.</span><span class="sxs-lookup"><span data-stu-id="2af40-239">Add-EFDefaultConnectionFactory either adds or updates the defaultConnectionFactory registration in the target project’s configuration file.</span></span>

<span data-ttu-id="2af40-240">Обе эти команды потребуют добавления раздела entityFramework в файл конфигурации и добавления коллекции поставщиков при необходимости.</span><span class="sxs-lookup"><span data-stu-id="2af40-240">Both these commands take care of adding an entityFramework section to the config file and adding a providers collection if necessary.</span></span>

<span data-ttu-id="2af40-241">Предполагается, что эти команды вызываются из скрипта install.ps1 NuGet.</span><span class="sxs-lookup"><span data-stu-id="2af40-241">It is intended that these commands be called from the install.ps1 NuGet script.</span></span> <span data-ttu-id="2af40-242">Например, install.ps1 для поставщика SQL Compact выглядит примерно так:</span><span class="sxs-lookup"><span data-stu-id="2af40-242">For example, install.ps1 for the SQL Compact provider looks similar to this:</span></span>

``` powershell
param($installPath, $toolsPath, $package, $project)
Add-EFDefaultConnectionFactory $project 'System.Data.Entity.Infrastructure.SqlCeConnectionFactory, EntityFramework' -ConstructorArguments 'System.Data.SqlServerCe.4.0'
Add-EFProvider $project 'System.Data.SqlServerCe.4.0' 'System.Data.Entity.SqlServerCompact.SqlCeProviderServices, EntityFramework.SqlServerCompact'</pre>
```

<span data-ttu-id="2af40-243">Дополнительные сведения об этих командах можно получить с помощью команды Get-Help в окне консоли диспетчера пакетов.</span><span class="sxs-lookup"><span data-stu-id="2af40-243">More information about these commands can be obtained by using get-help in the Package Manager Console window.</span></span>

## <a name="wrapping-providers"></a><span data-ttu-id="2af40-244">Создание оболочек для поставщиков</span><span class="sxs-lookup"><span data-stu-id="2af40-244">Wrapping providers</span></span>

<span data-ttu-id="2af40-245">Поставщик упаковки — это поставщик EF или ADO.NET, который создает оболочку для существующего поставщика и расширяет его с помощью других функциональных возможностей, таких как возможности профилирования или трассировки.</span><span class="sxs-lookup"><span data-stu-id="2af40-245">A wrapping provider is an EF and/or ADO.NET provider that wraps an existing provider to extend it with other functionality such as profiling or tracing capabilities.</span></span> <span data-ttu-id="2af40-246">Поставщики замедления могут быть зарегистрированы обычным способом, но часто бывает удобнее настроить поставщик оболочки во время выполнения путем перехвата разрешения служб, связанных с поставщиком.</span><span class="sxs-lookup"><span data-stu-id="2af40-246">Wrapping providers can be registered in the normal way, but it is often more convenient to setup the wrapping provider at runtime by intercepting the resolution of provider-related services.</span></span> <span data-ttu-id="2af40-247">Для этого можно использовать статическое событие Онлоккингконфигуратион в классе DbConfiguration.</span><span class="sxs-lookup"><span data-stu-id="2af40-247">The static event OnLockingConfiguration on the DbConfiguration class can be used to do this.</span></span>

<span data-ttu-id="2af40-248">Онлоккингконфигуратион вызывается после того, как EF определит, куда будет получена вся конфигурация EF для домена приложения, но до того, как он был заблокирован для использования.</span><span class="sxs-lookup"><span data-stu-id="2af40-248">OnLockingConfiguration is called after EF has determined where all EF configuration for the app domain will be obtained from but before it is locked for use.</span></span> <span data-ttu-id="2af40-249">При запуске приложения (перед использованием EF) приложение должно зарегистрировать обработчик событий для этого события.</span><span class="sxs-lookup"><span data-stu-id="2af40-249">At app startup (before EF is used) the app should register an event handler for this event.</span></span> <span data-ttu-id="2af40-250">(Мы рекомендуем добавить поддержку регистрации этого обработчика в файле конфигурации, но это еще не поддерживается.) После этого обработчик событий должен вызвать Реплацесервице для каждой службы, которая должна быть заключена в оболочку.</span><span class="sxs-lookup"><span data-stu-id="2af40-250">(We are considering adding support for registering this handler in the config file but this is not yet supported.) The event handler should then make a call to ReplaceService for every service that needs to be wrapped.</span></span>  

<span data-ttu-id="2af40-251">Например, чтобы заключить в оболочку Идбконнектионфактори и Дбпровидерсервице, необходимо зарегистрировать обработчик примерно следующего вида:</span><span class="sxs-lookup"><span data-stu-id="2af40-251">For example, to wrap IDbConnectionFactory and DbProviderService, a handler something like this should be registered:</span></span>

``` csharp
DbConfiguration.OnLockingConfiguration +=
    (_, a) =>
    {
        a.ReplaceService<DbProviderServices>(
            (s, k) => new MyWrappedProviderServices(s));

        a.ReplaceService<IDbConnectionFactory>(
            (s, k) => new MyWrappedConnectionFactory(s));
    };
```

<span data-ttu-id="2af40-252">Служба, которая была разрешена и теперь должна быть упакована вместе с ключом, который использовался для разрешения этой службы, передается в обработчик.</span><span class="sxs-lookup"><span data-stu-id="2af40-252">The service that has been resolved and should now be wrapped together with the key that was used to resolve the service are passed to the handler.</span></span> <span data-ttu-id="2af40-253">Затем обработчик может заключить эту службу в оболочку и заменить возвращенную службу на упакованную версию.</span><span class="sxs-lookup"><span data-stu-id="2af40-253">The handler can then wrap this service and replace the returned service with the wrapped version.</span></span>

## <a name="resolving-a-dbproviderfactory-with-ef"></a><span data-ttu-id="2af40-254">Разрешение DbProviderFactory с помощью EF</span><span class="sxs-lookup"><span data-stu-id="2af40-254">Resolving a DbProviderFactory with EF</span></span>

<span data-ttu-id="2af40-255">DbProviderFactory является одним из основных типов поставщиков, необходимых для EF, как описано в разделе _Обзор типов поставщиков_ выше.</span><span class="sxs-lookup"><span data-stu-id="2af40-255">DbProviderFactory is one of the fundamental provider types needed by EF as described in the _Provider types overview_ section above.</span></span> <span data-ttu-id="2af40-256">Как уже упоминалось, это не тип EF и регистрация, как правило, не являются частью конфигурации EF, но вместо обычной регистрации поставщика ADO.NET в файле machine.config и/или файле конфигурации приложения.</span><span class="sxs-lookup"><span data-stu-id="2af40-256">As already mentioned, It is not an EF type and registration is usually not part of EF configuration, but is instead the normal ADO.NET provider registration in the machine.config file and/or application’s config file.</span></span>

<span data-ttu-id="2af40-257">Несмотря на то, что этот EF по-прежнему использует стандартный механизм разрешения зависимостей при поиске DbProviderFactory для использования.</span><span class="sxs-lookup"><span data-stu-id="2af40-257">Despite this EF still uses its normal dependency resolution mechanism when looking for a DbProviderFactory to use.</span></span> <span data-ttu-id="2af40-258">Сопоставитель по умолчанию использует обычную регистрацию ADO.NET в файлах конфигурации, поэтому обычно это прозрачно.</span><span class="sxs-lookup"><span data-stu-id="2af40-258">The default resolver uses the normal ADO.NET registration in the config files and so this is usually transparent.</span></span> <span data-ttu-id="2af40-259">Однако из-за использования обычного механизма разрешения зависимостей это означает, что Идбдепенденциресолвер можно использовать для разрешения DbProviderFactory, даже если нормальная регистрация ADO.NET не выполнена.</span><span class="sxs-lookup"><span data-stu-id="2af40-259">But because of the normal dependency resolution mechanism is used it means that an IDbDependencyResolver can be used to resolve a DbProviderFactory even when normal ADO.NET registration has not been done.</span></span>

<span data-ttu-id="2af40-260">Разрешение DbProviderFactory таким образом имеет несколько последствий:</span><span class="sxs-lookup"><span data-stu-id="2af40-260">Resolving DbProviderFactory in this way has several implications:</span></span>

*   <span data-ttu-id="2af40-261">Приложение, использующее конфигурацию на основе кода, может добавлять вызовы в свой класс DbConfiguration для регистрации соответствующего DbProviderFactory.</span><span class="sxs-lookup"><span data-stu-id="2af40-261">An application using code-based configuration can add calls in their DbConfiguration class to register the appropriate DbProviderFactory.</span></span> <span data-ttu-id="2af40-262">Это особенно полезно для приложений, которые не хотят (или не могут) использовать файловую конфигурацию вообще.</span><span class="sxs-lookup"><span data-stu-id="2af40-262">This is especially useful for applications that do not want to (or cannot) make use of any file-based configuration at all.</span></span>
*   <span data-ttu-id="2af40-263">Службу можно обернуть или заменить с помощью Реплацесервице, как описано в разделе о _поставщиках упаковки_ выше.</span><span class="sxs-lookup"><span data-stu-id="2af40-263">The service can be wrapped or replaced using ReplaceService as described in the _Wrapping providers_ section above</span></span>
*   <span data-ttu-id="2af40-264">Теоретически, реализация DbProviderServices может разрешить DbProviderFactory.</span><span class="sxs-lookup"><span data-stu-id="2af40-264">Theoretically, a DbProviderServices implementation could resolve a DbProviderFactory.</span></span>

<span data-ttu-id="2af40-265">Важно отметить, что при выполнении любого из этих действий они будут влиять только на поиск DbProviderFactory по EF.</span><span class="sxs-lookup"><span data-stu-id="2af40-265">The important point to note about doing any of these things is that they will only affect the lookup of DbProviderFactory by EF.</span></span> <span data-ttu-id="2af40-266">Другой код, не связанный с EF, может по-прежнему рассчитывать на то, что поставщик ADO.NET будет зарегистрирован обычным образом и может завершиться ошибкой, если регистрация не найдена.</span><span class="sxs-lookup"><span data-stu-id="2af40-266">Other non-EF code may still expect the ADO.NET provider to be registered in the normal way and may fail if the registration is not found.</span></span> <span data-ttu-id="2af40-267">По этой причине лучше DbProviderFactory регистрацию в обычном ADO.NET.</span><span class="sxs-lookup"><span data-stu-id="2af40-267">For this reason it is normally better for a DbProviderFactory to be registered in the normal ADO.NET way.</span></span>

### <a name="related-services"></a><span data-ttu-id="2af40-268">Связанные службы</span><span class="sxs-lookup"><span data-stu-id="2af40-268">Related services</span></span>

<span data-ttu-id="2af40-269">Если EF используется для разрешения DbProviderFactory, он также должен разрешить службы Ипровидеринвариантнаме и Идбпровидерфакториресолвер.</span><span class="sxs-lookup"><span data-stu-id="2af40-269">If EF is used to resolve a DbProviderFactory, then it should also resolve the IProviderInvariantName and IDbProviderFactoryResolver services.</span></span>

<span data-ttu-id="2af40-270">Ипровидеринвариантнаме — это служба, которая используется для определения инвариантного имени поставщика для данного типа DbProviderFactory.</span><span class="sxs-lookup"><span data-stu-id="2af40-270">IProviderInvariantName is a service that is used to determine a provider invariant name for a given type of DbProviderFactory.</span></span> <span data-ttu-id="2af40-271">Реализация по умолчанию этой службы использует регистрацию поставщика ADO.NET.</span><span class="sxs-lookup"><span data-stu-id="2af40-271">The default implementation of this service uses the ADO.NET provider registration.</span></span> <span data-ttu-id="2af40-272">Это означает, что если поставщик ADO.NET не зарегистрирован обычным образом, поскольку DbProviderFactory разрешается EF, то он также потребуется для разрешения этой службы.</span><span class="sxs-lookup"><span data-stu-id="2af40-272">This means that if the ADO.NET provider is not registered in the normal way because DbProviderFactory is being resolved by EF, then it will also be necessary to resolve this service.</span></span> <span data-ttu-id="2af40-273">Обратите внимание, что сопоставитель для этой службы автоматически добавляется при использовании метода DbConfiguration. Сетпровидерфактори.</span><span class="sxs-lookup"><span data-stu-id="2af40-273">Note that a resolver for this service is automatically added when using the DbConfiguration.SetProviderFactory method.</span></span>

<span data-ttu-id="2af40-274">Как описано в разделе _Общие сведения о типах поставщиков_ , идбпровидерфакториресолвер используется для получения правильного DbProviderFactory из данного объекта DbConnection.</span><span class="sxs-lookup"><span data-stu-id="2af40-274">As described in the _Provider types overview_ section above, the IDbProviderFactoryResolver is used to obtain the correct DbProviderFactory from a given DbConnection object.</span></span> <span data-ttu-id="2af40-275">Реализация по умолчанию для этой службы при работе в .NET 4 использует регистрацию поставщика ADO.NET.</span><span class="sxs-lookup"><span data-stu-id="2af40-275">The default implementation of this service when running on .NET 4 uses the ADO.NET provider registration.</span></span> <span data-ttu-id="2af40-276">Это означает, что если поставщик ADO.NET не зарегистрирован обычным образом, поскольку DbProviderFactory разрешается EF, то он также потребуется для разрешения этой службы.</span><span class="sxs-lookup"><span data-stu-id="2af40-276">This means that if the ADO.NET provider is not registered in the normal way because DbProviderFactory is being resolved by EF, then it will also be necessary to resolve this service.</span></span>
