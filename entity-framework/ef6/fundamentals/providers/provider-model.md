---
title: Модели поставщика Entity Framework 6 - EF6
author: divega
ms.date: 06/27/2018
ms.assetid: 066832F0-D51B-4655-8BE7-C983C557E0E4
ms.openlocfilehash: de2e0a24f1b5f67d28cb831491b50d32f45af60a
ms.sourcegitcommit: 269c8a1a457a9ad27b4026c22c4b1a76991fb360
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 09/18/2018
ms.locfileid: "46283931"
---
# <a name="the-entity-framework-6-provider-model"></a>Модели поставщика Entity Framework 6

Модель поставщика Entity Framework позволяет Entity Framework для использования с различными типами сервера базы данных. Например один поставщик можно подключить разрешающее EF для использования Microsoft SQL Server, хотя можно подключить другого поставщика к разрешающее EF для использования Microsoft SQL Server Compact Edition. Поставщики для EF6, нам известно можно найти на [поставщики Entity Framework](~/ef6/fundamentals/providers/index.md) страницы.

Некоторые изменения требовались так, как EF взаимодействует с поставщиками, чтобы разрешить EF освобождения лицензии с открытым исходным кодом. Эти изменения к перестройке поставщиков EF отношению к сборкам EF6, а также новые механизмы для регистрации поставщика.

## <a name="rebuilding"></a>Перестроение

С помощью EF6 базовый код, который ранее был частью .NET Framework теперь поставляется в качестве сборки (OOB)-каналу. Сведения о том, как создавать приложения для EF6 можно найти на [обновление приложений для EF6](~/ef6/what-is-new/upgrading-to-ef6.md) страницы. Поставщики также необходимо перестроить с помощью следующей процедуры.

## <a name="provider-types-overview"></a>Общие сведения о типах поставщика

Поставщик EF действительно является коллекцией из поставщика служб, определяемых типов CLR, эти службы расширяет из (для базового класса) или не реализует (для интерфейса). Два из этих служб, являются основными и необходимые для Entity FRAMEWORK работать вообще. Другие являются необязательными и только должны быть реализованы, если определенные функции необходимо и/или реализации по умолчанию из этих служб не работает для конкретной базы данных сервера.

## <a name="fundamental-provider-types"></a>Поставщик фундаментальные типы

### <a name="dbproviderfactory"></a>DbProviderFactory

EF зависит от наличия типа, производного от [System.Data.Common.DbProviderFactory](https://msdn.microsoft.com/en-us/library/system.data.common.dbproviderfactory.aspx) для выполнения всех базы данных низкого уровня доступа. DbProviderFactory не фактически является частью EF, а вместо этого является, класс в .NET Framework, которая служит точкой входа для поставщиков ADO.NET может использоваться платформой EF, другие O/RMs или непосредственно приложением для получения экземпляров подключения, команды, параметры и другие абстракции ADO.NET в поставщике узлам. Дополнительные сведения о DbProviderFactory см. в [документацию MSDN для ADO.NET](https://msdn.microsoft.com/en-us/library/a6cd7c08.aspx).

### <a name="dbproviderservices"></a>DbProviderServices

EF зависит от наличия типа, производного от DbProviderServices для добавления новых функциональных возможностей, необходимых EF на основе функциональности, уже предоставляемых поставщиком ADO.NET. В более старых версиях EF класса DbProviderServices входил в состав .NET Framework и был найден в пространстве имен System.Data.Common. Начиная с EF6 этот класс теперь является частью EntityFramework.dll и находится в пространстве имен System.Data.Entity.Core.Common.

Дополнительные сведения об основных возможностях DbProviderServices реализации можно найти на [MSDN](https://msdn.microsoft.com/en-us/library/ee789835.aspx). Тем не менее Обратите внимание на то, что по состоянию на момент написания статьи эта информация не обновляется для EF6 несмотря на то, что большинства понятий, по-прежнему допустимы. Для реализации SQL Server и SQL Server Compact DbProviderServices также возвращены в [codebase открытым исходным кодом](https://github.com/aspnet/EntityFramework6/) и могут служить полезных ссылок для других реализаций.

В более старых версиях EF реализация DbProviderServices для использования были получены напрямую из поставщика ADO.NET. Это было сделано, приведение DbProviderFactory IServiceProvider и вызвать метод GetService. Это тесно связан поставщик EF с DbProviderFactory. Такое объединение заблокирован EF из .NET Framework и поэтому для EF6 тесной связи была удалена и реализация DbProviderServices зарегистрирован непосредственно в файле конфигурации приложения или на основе кода конфигурации, как описано более подробно _регистрации DbProviderServices_ разделе ниже.

## <a name="additional-services"></a>Дополнительные службы

Помимо основных служб, описанных выше существуют также многие другие службы, используемые EF, всегда или иногда от поставщика. Реализация поставщика по умолчанию этих служб может быть предоставленный реализация DbProviderServices. Приложения можно также переопределить реализации этих служб или предоставить реализации, если тип DbProviderServices не предоставляет значение по умолчанию. Это описано более подробно в _разрешение дополнительных служб_ разделе ниже.

Ниже перечислены типы дополнительная служба, поставщик может представлять интерес для поставщика. Дополнительные сведения о каждом из типов служб можно найти в документации по API.

### <a name="idbexecutionstrategy"></a>IDbExecutionStrategy

Это дополнительная служба, которая позволяет поставщику для реализации повторных попыток или другого поведения, при выполнении запросов и команд в базе данных. Если реализации не указаны, затем EF будет просто выполните команды и распространить все исключения. Для SQL Server эта служба используется для предоставления политику повтора, что особенно полезно при запуске для серверов базы данных на основе облака, таких как SQL Azure.

### <a name="idbconnectionfactory"></a>IDbConnectionFactory

Это дополнительная служба, которая позволяет поставщику для создания объектов DbConnection по соглашению при наличии только имени базы данных. Обратите внимание, что хотя эта служба может разрешить реализация DbProviderServices он был присутствовавшая EF 4.1 и можно также задать явным образом в файле конфигурации или в коде. Поставщик получит только возможность самому разрешить эту службу, если она зарегистрирована как поставщик по умолчанию (см. в разделе _поставщика по умолчанию_ ниже) и если фабрика соединений по умолчанию не было задано в другом месте.

### <a name="dbspatialservices"></a>DbSpatialServices

Это дополнительные службы, которые позволяет поставщику добавить поддержку Пространственные типы geography и geometry. Реализация этой службы должны предоставляться в приложение для использования EF с Пространственные типы. DbSptialServices запрашивается двумя способами. Во-первых, поставщика пространственной службы запрашиваются с помощью объекта DbProviderInfo (который содержит инвариант имя и маркер манифеста) как ключ. Во-вторых DbSpatialServices могут запрашиваться без ключа. Это используется для разрешения «глобальные пространственных поставщик», используемый при создании автономного DbGeography или DbGeometry типов.

### <a name="migrationsqlgenerator"></a>MigrationSqlGenerator

Это дополнительная служба, позволяющий миграции EF, используемые для создания SQL, используемый в создании и изменении схем баз данных Code First. Реализация необходим для поддержки миграции. Если реализация затем он будет использоваться при создании базы данных с помощью инициализаторов базы данных или метода Database.Create.

### <a name="funcdbconnection-string-historycontextfactory"></a>Func < DbConnection, строка, HistoryContextFactory >

Это дополнительная служба, которая позволяет поставщику настроить сопоставление HistoryContext для `__MigrationHistory` таблицу, используемую миграции EF. HistoryContext является первый DbContext кода и могут быть настроены в обычном fluent API для изменения действия, такие как имя таблицы и спецификации сопоставления столбцов. Реализация по умолчанию эта служба, возвращенных EF для всех поставщиков может работать для заданной базы данных сервера, если этот поставщик поддерживает все сопоставления по умолчанию таблиц и столбцов. В этом случае поставщик не нужно предоставлять реализацию этой службы.

### <a name="idbproviderfactoryresolver"></a>IDbProviderFactoryResolver

Это дополнительная служба для получения правильного DbProviderFactory из указанного объекта DbConnection. Реализация по умолчанию эта служба, возвращенных EF для всех поставщиков предназначен для работы для всех поставщиков. Тем не менее, при выполнении в .NET 4, объект DbProviderFactory не является общедоступной с одним из его DbConnections. Таким образом EF использует часть эвристических правил для поиска зарегистрированных поставщиков для поиска совпадений. Вполне возможно, что некоторые поставщики таких методов завершится ошибкой, и в таких ситуациях поставщик должен предоставить новую реализацию.

## <a name="registering-dbproviderservices"></a>Регистрация DbProviderServices

Реализация DbProviderServices для использования могут быть зарегистрированы в файл конфигурации (app.config или web.config) или с помощью конфигурации на основе кода приложения. В любом случае регистрации использует «неизменяемое имя поставщика» в качестве ключа. Благодаря этому несколько поставщиков зарегистрировать и использовать их в одном приложении. Инвариантное имя, используемое для регистрации EF совпадает неизменяемое имя, используемое для регистрации и соединения строки поставщика ADO.NET. Например для SQL Server неизменяемое имя «System.Data.SqlClient»» используется.

### <a name="config-file-registration"></a>Регистрация в файле конфигурации

Тип DbProviderServices для использования регистрируется как поставщик элемент в списке поставщиков entityFramework раздела файла конфигурации приложения. Пример:

``` xml
<entityFramework>
  <providers>
    <provider invariantName="My.Invariant.Name" type="MyProvider.MyProviderServices, MyAssembly" />
  </providers>
</entityFramework>
```

_Тип_ строка должна быть реализация DbProviderServices нужно использовать имя типа с указанием сборки.

### <a name="code-based-registration"></a>Регистрация на основе кода

Начиная с EF6 поставщиков также можно зарегистрировать с помощью кода. Это позволяет поставщика EF использовать без изменения в файл конфигурации приложения. Для использования конфигурации на основе кода приложения необходимо создать класс DbConfiguration, как описано в разделе [документации конфигурация на основе кода](https://msdn.com/data/jj680699). Конструктор класса DbConfiguration необходимо вызвать SetProviderServices для регистрации поставщика EF. Пример:

``` csharp
public class MyConfiguration : DbConfiguration
{
    public MyConfiguration()
    {
        SetProviderServices("My.New.Provider", new MyProviderServices());
    }
}
```

## <a name="resolving-additional-services"></a>Разрешение дополнительных служб

Как упоминалось выше в _Обзор типов поставщика_ разделе DbProviderServices класс может также использоваться для разрешения дополнительных служб. Это возможно, поскольку DbProviderServices реализует IDbDependencyResolver и каждого зарегистрированного типа DbProviderServices добавляется в качестве «Сопоставитель по умолчанию». Более подробно описан механизм IDbDpendencyResolver [разрешение зависимостей](~/ef6/fundamentals/configuring/dependency-resolution.md). Тем не менее необязательно знать все понятия, описанные в этой спецификации для разрешения дополнительных служб в поставщике.

Наиболее распространенным способом для поставщика для разрешения дополнительных служб является вызов DbProviderServices.AddDependencyResolver для каждой службы в конструктор класса DbProviderServices. Например SqlProviderServices (EF поставщика для SQL Server) имеет примерно такой для инициализации код:

``` csharp
private SqlProviderServices()
{
    AddDependencyResolver(new SingletonDependencyResolver<IDbConnectionFactory>(
        new SqlConnectionFactory()));

    AddDependencyResolver(new ExecutionStrategyResolver<DefaultSqlExecutionStrategy>(
        "System.data.SqlClient", null, () => new DefaultSqlExecutionStrategy()));

    AddDependencyResolver(new SingletonDependencyResolver<Func<MigrationSqlGenerator>>(
        () => new SqlServerMigrationSqlGenerator(), "System.data.SqlClient"));

    AddDependencyResolver(new SingletonDependencyResolver<DbSpatialServices>(
        SqlSpatialServices.Instance,
        k =>
        {
            var asSpatialKey = k as DbProviderInfo;
            return asSpatialKey == null
                || asSpatialKey.ProviderInvariantName == ProviderInvariantName;
        }));
}
```

Этот конструктор использует следующие вспомогательные классы:

*   SingletonDependencyResolver: предоставляет простой способ устранить одноэлементные службы — то есть служб, для которых тот же экземпляр возвращается каждый раз, что вызывается GetService. Временные службы часто регистрируются как одноэлементная фабрика, которая будет использоваться для создания временных экземпляров по запросу.
*   ExecutionStrategyResolver: арбитра для возвращения IExecutionStrategy реализаций.

Вместо использования DbProviderServices.AddDependencyResolver можно также переопределить DbProviderServices.GetService и непосредственно устранить дополнительных служб. Этот метод будет вызываться, когда EF определены определенного типа и, в некоторых случаях для заданного ключа службы. Метод должен вернуть службы, способно или возвращать значение null, чтобы отказаться от возврата службы и позволит другому классу для ее устранения. Например чтобы устранить фабрика соединений по умолчанию код в GetService может выглядеть примерно следующим образом:

``` csharp
public override object GetService(Type type, object key)
{
    if (type == typeof(IDbConnectionFactory))
    {
        return new SqlConnectionFactory();
    }
    return null;
}
```

### <a name="registration-order"></a>Порядок регистрации

Когда несколько реализаций DbProviderServices регистрируются в файле конфигурации приложения они добавляются в качестве вторичного сопоставителей в порядке, в котором они перечислены. Так как сопоставители всегда добавляются к верхней части цепочки вторичной Сопоставитель, это означает, что поставщик в конце списка получит возможность разрешать зависимости раньше других. (Это может показаться немного неочевидным на первый, но имеет смысл если представить выполнением каждого поставщика из списка и размещения его поверх существующих поставщиков).

Этот порядок обычно не имеет значения, так как большинство поставщика службы поставщика и с помощью команд, неизменяемое имя поставщика. Тем не менее для служб, не идентифицируются по неизменяемое имя поставщика и некоторые другие поставщика ключ, служба будет разрешаться на основе этот порядок. Например если не задано явным образом по-разному где-то иначе, фабрика соединений по умолчанию получаются из верхних поставщик в цепи.

## <a name="additional-config-file-registrations"></a>Файл регистрации дополнительные конфигурации

Имеется возможность явно зарегистрировать некоторые дополнительного поставщика службы, описанной выше непосредственно в файле конфигурации приложения. После этого регистрации в файле конфигурации будет использоваться вместо ничего возвращаемый метод GetService реализация DbProviderServices.

### <a name="registering-the-default-connection-factory"></a>Регистрация фабрики подключения по умолчанию

Начиная с EF5 пакета EntityFramework NuGet автоматически зарегистрировать фабрику соединений SQL Express или LocalDb фабрики подключения в файле конфигурации.

Пример:

``` xml
<entityFramework>
  <defaultConnectionFactory type="System.Data.Entity.Infrastructure.SqlConnectionFactory, EntityFramework" >
</entityFramework>
```

_Тип_ — имя типа с указанием сборки для фабрика соединений по умолчанию, которая должна реализовывать интерфейс IDbConnectionFactory.

Мы рекомендуем что пакета NuGet поставщика фабрика соединений по умолчанию таким образом, при установке. См. в разделе _пакеты NuGet для поставщиков_ ниже.

## <a name="additional-ef6-provider-changes"></a>Дополнительные изменения поставщика EF6

### <a name="spatial-provider-changes"></a>Изменения пространственных поставщика

Поставщики, которые поддерживают Пространственные типы теперь необходимо реализовать некоторые дополнительные методы в классах, производных от DbSpatialDataReader:

*   `public abstract bool IsGeographyColumn(int ordinal)`
*   `public abstract bool IsGeometryColumn(int ordinal)`

Существует также новые асинхронные версии существующих методов, которые рекомендуются для переопределения, как делегировать синхронные методы реализации по умолчанию и поэтому не следует вызывать асинхронно.

*   `public virtual Task<DbGeography> GetGeographyAsync(int ordinal, CancellationToken cancellationToken)`
*   `public virtual Task<DbGeometry> GetGeometryAsync(int ordinal, CancellationToken cancellationToken)`

### <a name="native-support-for-enumerablecontains"></a>Встроенная поддержка Enumerable.Contains

EF6 появился новый тип выражения, DbInExpression, которая была добавлена для устранения проблем производительности, использовании Enumerable.Contains в запросах LINQ. Класс DbProviderManifest имеет новый виртуальный метод SupportsInExpression, который вызывается объектом EF, чтобы определить, если поставщик обрабатывает новый тип выражения. Для обеспечения совместимости с существующими реализациями поставщика, метод возвращает значение false. Чтобы извлечь пользу из этого улучшения, поставщик EF6 можно добавить код для обработки DbInExpression и переопределить SupportsInExpression возвращает значение true. Экземпляр DbInExpression могут создаваться путем вызова метода DbExpressionBuilder.In. Экземпляр DbInExpression представляет собой DbExpression, обычно представляющих столбец таблицы и списка DbConstantExpression для проверки на соответствие.

## <a name="nuget-packages-for-providers"></a>Пакеты NuGet для поставщиков

Один из способов сделать доступным один из поставщиков EF6 является выпустить ее в виде пакета NuGet. С помощью пакета NuGet имеет следующие преимущества:

*   Это простой в использовании NuGet для добавления регистрации поставщика в файле конфигурации приложения
*   Можно вносить дополнительные изменения в файл конфигурации для задания фабрика соединений по умолчанию, соединений, производимых по соглашению будут использовать зарегистрированный поставщик
*   NuGet обрабатывает добавление переадресации привязок, таким образом, чтобы поставщик EF6 должны продолжать работать даже в том случае, после выпуска нового пакета EF

Примером этого является, входящей в состав пакета EntityFramework.SqlServerCompact [открытым исходным кодом codebase](http://github.com/aspnet/entityframework6). Этот пакет предоставляет хороший шаблон для создания поставщика EF пакеты NuGet.

### <a name="powershell-commands"></a>Команды PowerShell

При установке пакета EntityFramework NuGet он регистрирует модуль PowerShell, который содержит две команды, которые очень полезны для поставщика пакетов:

*   Добавление EFProvider добавляет новую сущность для поставщика в файле конфигурации целевого проекта и гарантирует, что он находится в конце списка зарегистрированных поставщиков.
*   Добавление EFDefaultConnectionFactory добавляет или обновляет регистрацию defaultConnectionFactory в файле конфигурации целевого проекта.

Обе эти команды выполнит Добавление раздел entityFramework в файл конфигурации и Добавление коллекции поставщиков, при необходимости.

Предполагается, что эти команды вызываться из install.ps1 сценария NuGet. Например install.ps1 SQL Compact поставщика выглядит примерно так:

``` powershell
param($installPath, $toolsPath, $package, $project)
Add-EFDefaultConnectionFactory $project 'System.Data.Entity.Infrastructure.SqlCeConnectionFactory, EntityFramework' -ConstructorArguments 'System.Data.SqlServerCe.4.0'
Add-EFProvider $project 'System.Data.SqlServerCe.4.0' 'System.Data.Entity.SqlServerCompact.SqlCeProviderServices, EntityFramework.SqlServerCompact'</pre>
```

Дополнительные сведения об этих командах можно получить с помощью get-help в окне консоли диспетчера пакетов.

## <a name="wrapping-providers"></a>Перенос поставщиков

Перенос поставщик — поставщик EF и/или ADO.NET, который создает оболочку для существующего поставщика расширить ее с другими функциями, например профилирования или возможностей отслеживания. Упаковки поставщики могут регистрироваться обычным способом, но часто бывает более удобно для настройки поставщика упаковки во время выполнения путем перехвата разрешения, связанные с поставщиком служб. Для этого используется статическое событие OnLockingConfiguration DbConfiguration класса.

OnLockingConfiguration вызывается после EF определяет, где все конфигурации EF для домена приложения будут получены из, но до его блокировки для использования. При запуске приложения (до использования EF) приложение должно зарегистрироваться обработчик событий для данного события. (Мы рассматриваем, добавляя поддержку регистрации этого обработчика в файле конфигурации, но это еще не поддерживается). Обработчик событий, затем следует сделать вызов к ReplaceService для каждой службы, который должен быть заключен.  

Например программы-оболочки для IDbConnectionFactory и DbProviderService, должен быть зарегистрирован обработчик примерно так:

``` csharp
DbConfiguration.OnLockingConfiguration +=
    (_, a) =>
    {
        a.ReplaceService<DbProviderServices>(
            (s, k) => new MyWrappedProviderServices(s));

        a.ReplaceService<IDbConnectionFactory>(
            (s, k) => new MyWrappedConnectionFactory(s));
    };
```

Служба, которая будет разрешена и следует упаковывать вместе с ключом, который был использован для разрешения службы, передаются в обработчик. Обработчик можно переносить этой службы и заменить полученную упакованного версией.

## <a name="resolving-a-dbproviderfactory-with-ef"></a>Разрешение DbProviderFactory с EF

DbProviderFactory является одним из фундаментальных поставщика типов Затребован EF, как описано в разделе _Обзор типов поставщика_ предыдущем разделе. Как уже упоминалось, это не является типом EF и регистрации обычно не является частью конфигурации EF, а вместо этого является обычной регистрации поставщика ADO.NET в файле machine.config и в файле конфигурации приложения.

Несмотря на это EF по-прежнему использует его обычной зависимостью механизм разрешения конфликтов при поиске класса DbProviderFactory для использования. Сопоставитель по умолчанию использует обычный регистрации ADO.NET в файлах конфигурации, так что это обычно понятен. Однако из-за разрешения обычной зависимостью используется механизм это означает, что IDbDependencyResolver может использоваться для разрешения класса DbProviderFactory даже в том случае, если не было сделано обычной регистрации ADO.NET.

Разрешение DbProviderFactory таким образом ряд последствий:

*   Приложения с помощью конфигурации на основе кода можно добавить вызовы в классе DbConfiguration регистрируемый соответствующий объект DbProviderFactory. Это особенно полезно для приложений, которые не требуется (или не может) сделать вообще использовать какой-либо настройки на основе файлов.
*   Служба может переноситься или заменить с помощью ReplaceService, как описано в разделе _упаковки поставщики_ выше
*   Теоретически реализация DbProviderServices удалось разрешить класса DbProviderFactory.

Важно следует помнить о выполнении этих операций, то, что они будут влияют только на поиск DbProviderFactory платформой EF. Другой код не EF может по-прежнему требуется, чтобы поставщик ADO.NET для регистрации обычным способом и может завершиться ошибкой, если регистрация не найден. По этой причине лучше обычно для класса DbProviderFactory для регистрации обычным способом ADO.NET.

### <a name="related-services"></a>Связанные службы

Если EF используется для разрешения класса DbProviderFactory, то его необходимо разрешить IProviderInvariantName и IDbProviderFactoryResolver служб.

IProviderInvariantName — это служба, который используется для определения неизменяемое имя поставщика для данного типа DbProviderFactory. Реализация по умолчанию эта служба использует Регистрация поставщика ADO.NET. Это означает, что если поставщик ADO.NET не зарегистрирован обычным способом, так как объект DbProviderFactory разрешается путем EF, затем он также будет необходимо для устранения этой службы. Обратите внимание на то, что арбитр для этой службы автоматически добавляется при использовании метода DbConfiguration.SetProviderFactory.

Как описано в разделе _Обзор типов поставщика_ разделе выше, IDbProviderFactoryResolver используется для получения правильного DbProviderFactory из указанного объекта DbConnection. Реализация по умолчанию эта служба при выполнении в .NET 4 использует Регистрация поставщика ADO.NET. Это означает, что если поставщик ADO.NET не зарегистрирован обычным способом, так как объект DbProviderFactory разрешается путем EF, затем он также будет необходимо для устранения этой службы.
